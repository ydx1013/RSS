const API_BASE = '/api/routes';
        const PREVIEW_API = '/api/preview';
        const PROXY_API = '/api/visual-proxy';
        const PROXY_JSON_API = '/api/proxy';

        // --- Navigation ---
        function showPage(pageId) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page-' + pageId).classList.remove('hidden');
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.nav-btn').forEach(el => {
                if (el.dataset.target === pageId) {
                    el.classList.add('active', 'bg-blue-600', 'text-white');
                    el.classList.remove('text-gray-900', 'font-medium', 'hover:bg-gray-100');
                } else {
                    el.classList.remove('active', 'bg-blue-600', 'text-white');
                    el.classList.add('text-gray-900', 'font-medium', 'hover:bg-gray-100');
                }
            });

            // é¡µé¢ç‰¹å®šé€»è¾‘
            if (pageId === 'list') {
                loadRoutes();
            } else if (pageId === 'folders') {
                loadFolders();
            } else if (pageId === 'dashboard') {
                updateStats();
            } else if (pageId === 'editor') {
                // å¦‚æœæ˜¯æ–°å»ºè·¯ç”±ï¼ˆéç¼–è¾‘ï¼‰ï¼Œé‡ç½®è¡¨å•
                const routeKey = document.getElementById('routeKey').value;
                if (!routeKey || !cachedRoutes[routeKey]) {
                    resetForm();
                } else {
                    // ç¼–è¾‘æ¨¡å¼ä¹Ÿéšè—è°ƒè¯•æ—¥å¿—
                    const debugSection = document.getElementById('debugLogs');
                    if (debugSection) {
                        debugSection.classList.add('hidden');
                    }
                }
            }
        }

        function resetForm() {
            document.getElementById('routeForm').reset();
            // é‡ç½®ä¸ºé¢„è§ˆæ¨¡å¼
            document.getElementById('previewTitle').textContent = 'å¯è§†åŒ–é¢„è§ˆ';
            document.getElementById('visualPreview').classList.remove('hidden');
            document.getElementById('testResult').classList.add('hidden');
            document.getElementById('previewFrame').src = '';
            // éšè—è°ƒè¯•æ—¥å¿—
            const debugSection = document.getElementById('debugLogs');
            if (debugSection) {
                debugSection.classList.add('hidden');
                debugSection.innerHTML = '';
            }
        }

        // --- Data Logic ---
        let cachedRoutes = {};

        async function loadRoutes() {
            const listEl = document.getElementById('routeList');
            listEl.innerHTML = '<li class="p-4 text-center text-gray-500">åŠ è½½ä¸­...</li>';
            
            try {
                const res = await authFetch(API_BASE);
                cachedRoutes = await res.json();
                renderList();
                updateStats();
            } catch (e) {
                listEl.innerHTML = '<li class="p-4 text-center text-red-500">åŠ è½½å¤±è´¥: ' + e.message + '</li>';
            }
        }

        async function loadFolders() {
            const listEl = document.getElementById('folderList');
            listEl.innerHTML = '<div class="col-span-full p-4 text-center text-gray-500">åŠ è½½ä¸­...</div>';
            
            try {
                // Always fetch fresh data
                const res = await authFetch(API_BASE);
                cachedRoutes = await res.json();
                renderFolders();
            } catch (e) {
                listEl.innerHTML = '<div class="col-span-full p-4 text-center text-red-500">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
            }
        }

        function renderFolders() {
            const listEl = document.getElementById('folderList');
            
            // Group by folder
            const folders = {};
            Object.entries(cachedRoutes).forEach(([key, config]) => {
                if (config.folder) {
                    if (!folders[config.folder]) {
                        folders[config.folder] = {
                            name: config.folder,
                            count: 0,
                            routes: [],
                            lastUpdate: 0
                        };
                    }
                    folders[config.folder].count++;
                    folders[config.folder].routes.push(key);
                    if (config.status && config.status.lastUpdate > folders[config.folder].lastUpdate) {
                        folders[config.folder].lastUpdate = config.status.lastUpdate;
                    }
                }
            });
            
            const folderKeys = Object.keys(folders).sort();
            
            if (folderKeys.length === 0) {
                listEl.innerHTML = '<div class="col-span-full p-6 text-center text-gray-500 text-sm">æš‚æ— åˆé›†ï¼Œè¯·åœ¨ç¼–è¾‘è·¯ç”±æ—¶è®¾ç½®"æ–‡ä»¶å¤¹"å­—æ®µ</div>';
                return;
            }
            
            listEl.innerHTML = '';
            
            folderKeys.forEach(key => {
                const folder = folders[key];
                const li = document.createElement('div');
                li.className = 'bg-white rounded-lg shadow border border-gray-200 hover:shadow-md transition-shadow flex flex-col';
                li.innerHTML = `
                    <div class="p-4 flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-gray-900 truncate" title="${folder.name}">ğŸ“‚ ${folder.name}</h3>
                            <span class="badge bg-purple-100 text-purple-700 text-xs">${folder.count} ä¸ªè·¯ç”±</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3 line-clamp-2" title="${folder.routes.join(', ')}">åŒ…å«: ${folder.routes.join(', ')}</p>
                        ${folder.lastUpdate ? 
                            `<p class="text-xs text-gray-400">æœ€è¿‘æ›´æ–°: ${timeAgo(folder.lastUpdate)}</p>` 
                            : '<p class="text-xs text-gray-400">æš‚æ— æ›´æ–°è®°å½•</p>'}
                    </div>
                    <div class="bg-gray-50 px-4 py-3 border-t border-gray-100 flex items-center justify-between rounded-b-lg">
                        <div class="flex gap-2">
                            <a href="/?folder=${encodeURIComponent(folder.name)}&format=rss" target="_blank" class="text-orange-500 hover:text-orange-600 flex items-center gap-1 text-xs font-medium">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                                RSS
                            </a>
                            <a href="/?folder=${encodeURIComponent(folder.name)}&format=atom" target="_blank" class="text-blue-500 hover:text-blue-600 flex items-center gap-1 text-xs font-medium">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                Atom
                            </a>
                            <a href="/?folder=${encodeURIComponent(folder.name)}&format=json" target="_blank" class="text-green-500 hover:text-green-600 flex items-center gap-1 text-xs font-medium">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                JSON
                            </a>
                        </div>
                        <button onclick="openFolderModal('${folder.name}')" class="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            ç¼–è¾‘
                        </button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        }

        // --- Folder Management ---
        let currentEditingFolder = null;

        function openFolderModal(folderName = null) {
            currentEditingFolder = folderName;
            const modal = document.getElementById('folderModal');
            const title = document.getElementById('folderModalTitle');
            const nameInput = document.getElementById('folderNameInput');
            const list = document.getElementById('folderRouteList');
            const search = document.getElementById('folderRouteSearch');
            
            modal.classList.remove('hidden');
            search.value = '';
            
            if (folderName) {
                title.textContent = 'ç¼–è¾‘åˆé›†';
                nameInput.value = folderName;
            } else {
                title.textContent = 'æ–°å»ºåˆé›†';
                nameInput.value = '';
            }
            
            // Render route list
            list.innerHTML = '';
            const keys = Object.keys(cachedRoutes).sort();
            
            if (keys.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4 text-sm">æš‚æ— è·¯ç”±å¯ä¾›é€‰æ‹©</div>';
                return;
            }
            
            keys.forEach(key => {
                const config = cachedRoutes[key];
                const isSelected = folderName && config.folder === folderName;
                
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 hover:bg-gray-100 rounded border-b border-gray-100 last:border-0 route-item';
                div.dataset.key = key; // For filtering
                
                div.innerHTML = `
                    <label class="flex items-center flex-1 cursor-pointer">
                        <input type="checkbox" class="rounded border-gray-300 text-blue-600 mr-3 route-checkbox" value="${key}" ${isSelected ? 'checked' : ''}>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-900 truncate">${key}</span>
                                ${config.folder && config.folder !== folderName ? `<span class="text-xs text-gray-400 ml-2 bg-gray-100 px-1 rounded">å·²åœ¨: ${config.folder}</span>` : ''}
                            </div>
                            <p class="text-xs text-gray-500 truncate">${config.url}</p>
                        </div>
                    </label>
                `;
                list.appendChild(div);
            });
        }

        function closeFolderModal() {
            document.getElementById('folderModal').classList.add('hidden');
            currentEditingFolder = null;
        }

        function filterFolderRoutes() {
            const query = document.getElementById('folderRouteSearch').value.toLowerCase();
            document.querySelectorAll('#folderRouteList .route-item').forEach(item => {
                const key = item.dataset.key.toLowerCase();
                if (key.includes(query)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        async function saveFolder() {
            const newName = document.getElementById('folderNameInput').value.trim();
            if (!newName) {
                alert('è¯·è¾“å…¥åˆé›†åç§°');
                return;
            }
            
            const btn = document.getElementById('saveFolderBtn');
            const originalText = btn.textContent;
            btn.textContent = 'ä¿å­˜ä¸­...';
            btn.disabled = true;
            
            try {
                const updates = {};
                const checkboxes = document.querySelectorAll('.route-checkbox');
                
                checkboxes.forEach(cb => {
                    const key = cb.value;
                    const config = cachedRoutes[key];
                    const isChecked = cb.checked;
                    
                    // Logic:
                    // 1. If checked, set folder to newName
                    // 2. If unchecked AND it was previously in this folder (currentEditingFolder), remove folder
                    // 3. If unchecked AND it was in another folder, leave it alone
                    
                    if (isChecked) {
                        if (config.folder !== newName) {
                            updates[key] = { ...config, folder: newName };
                        }
                    } else {
                        if (currentEditingFolder && config.folder === currentEditingFolder) {
                            updates[key] = { ...config, folder: '' };
                        }
                    }
                });
                
                // Also handle renaming: if we renamed the folder, we need to update all routes that were in the old folder
                // but are NOT in the current selection (though the logic above handles unchecked items)
                // Wait, if I rename "Tech" to "Technology", currentEditingFolder is "Tech".
                // If I check a box, it gets "Technology".
                // If I uncheck a box that was "Tech", it gets "".
                // This seems correct.
                
                if (Object.keys(updates).length === 0) {
                    closeFolderModal();
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }
                
                const res = await authFetch(API_BASE, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                
                if (res.ok) {
                    closeFolderModal();
                    loadFolders(); // Reload list
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + await res.text());
                }
            } catch (e) {
                alert('ä¿å­˜å‡ºé”™: ' + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function renderList() {
            const listEl = document.getElementById('routeList');
            listEl.innerHTML = '';
            listEl.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4'; // Change to grid
            
            const keys = Object.keys(cachedRoutes).reverse(); // Reverse order
            if (keys.length === 0) {
                listEl.innerHTML = '<div class="col-span-full p-6 text-center text-gray-500 text-sm">æš‚æ— è·¯ç”±ï¼Œè¯·å‰å¾€ç¼–è¾‘å™¨æ·»åŠ </div>';
                return;
            }

            keys.forEach(key => {
                const config = cachedRoutes[key];
                const li = document.createElement('div'); // Change to div
                li.className = 'bg-white rounded-lg shadow border border-gray-200 hover:shadow-md transition-shadow flex flex-col';
                li.innerHTML = `
                    <div class="p-4 flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-base font-semibold text-gray-900 truncate" title="${key}">${key}</h3>
                            <div class="flex gap-1">
                                ${config.folder ? `<span class="badge bg-purple-50 text-purple-700 text-xs" title="æ–‡ä»¶å¤¹: ${config.folder}">${config.folder}</span>` : ''}
                                <span class="badge bg-gray-100 text-gray-700 text-xs">${config.type || 'html'}</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 truncate mb-3" title="${config.url}">${config.url}</p>
                        <div class="flex flex-wrap gap-1 mb-3">
                            <span class="badge bg-blue-50 text-blue-700 text-xs">${config.maxItems || 20} æ¡</span>
                            ${config.fullText ? '<span class="badge bg-orange-50 text-orange-700 text-xs">å…¨æ–‡</span>' : ''}
                            ${config.status && config.status.lastUpdate ? 
                                `<span class="badge bg-green-50 text-green-700 text-xs" title="å†…å®¹æ›´æ–°äº: ${new Date(config.status.lastUpdate).toLocaleString()}">å†…å®¹æ›´æ–°: ${timeAgo(config.status.lastUpdate)}</span>` 
                                : ''}
                        </div>
                        <p class="text-xs text-gray-400 mb-2">é…ç½®æ›´æ–°äº: ${config.updatedAt ? new Date(config.updatedAt).toLocaleString() : 'æœªçŸ¥'}</p>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 border-t border-gray-100 flex items-center justify-between rounded-b-lg">
                        <div class="flex gap-2">
                            <a href="/?custom=${key}.rss" target="_blank" class="text-orange-500 hover:text-orange-600" title="RSS">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                            </a>
                            <a href="/?custom=${key}.atom" target="_blank" class="text-blue-500 hover:text-blue-600" title="Atom">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            </a>
                            <a href="/?custom=${key}.json" target="_blank" class="text-green-500 hover:text-green-600" title="JSON">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            </a>
                        </div>
                        <div class="flex gap-2">
                            <button onclick='editRoute("${key}")' class="text-xs text-blue-600 hover:text-blue-800 font-medium">ç¼–è¾‘</button>
                            <button onclick="deleteRoute('${key}')" class="text-xs text-red-600 hover:text-red-800 font-medium">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                listEl.appendChild(li);
            });
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = Object.keys(cachedRoutes).length;
            
            const allRoutes = Object.entries(cachedRoutes)
                .filter(([_, config]) => config.status && config.status.lastUpdate);

            // --- Recent Updates (Top 10) ---
            const recentContainer = document.getElementById('stat-recent');
            if (recentContainer) {
                const recentRoutes = [...allRoutes]
                    .sort((a, b) => b[1].status.lastUpdate - a[1].status.lastUpdate)
                    .slice(0, 10);
                    
                if (recentRoutes.length === 0) {
                    recentContainer.innerHTML = '<p class="text-sm text-gray-400">æš‚æ— æ›´æ–°è®°å½•</p>';
                } else {
                    recentContainer.innerHTML = recentRoutes.map(([key, config]) => `
                        <div class="flex items-center justify-between text-sm border-b border-gray-100 pb-2 last:border-0 last:pb-0">
                            <div class="flex items-center gap-2 truncate">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                <span class="font-medium text-gray-700 truncate" title="${key}">${key}</span>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">${timeAgo(config.status.lastUpdate)}</span>
                        </div>
                    `).join('');
                }
            }

            // --- Oldest Updates (Top 10) ---
            const oldestContainer = document.getElementById('stat-oldest');
            if (oldestContainer) {
                const oldestRoutes = [...allRoutes]
                    .sort((a, b) => a[1].status.lastUpdate - b[1].status.lastUpdate)
                    .slice(0, 10);
                    
                if (oldestRoutes.length === 0) {
                    oldestContainer.innerHTML = '<p class="text-sm text-gray-400">æš‚æ— æ›´æ–°è®°å½•</p>';
                } else {
                    oldestContainer.innerHTML = oldestRoutes.map(([key, config]) => `
                        <div class="flex items-center justify-between text-sm border-b border-gray-100 pb-2 last:border-0 last:pb-0">
                            <div class="flex items-center gap-2 truncate">
                                <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                                <span class="font-medium text-gray-700 truncate" title="${key}">${key}</span>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">${timeAgo(config.status.lastUpdate)}</span>
                        </div>
                    `).join('');
                }
            }
        }

        function timeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'åˆšåˆš';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'åˆ†é’Ÿå‰';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'å°æ—¶å‰';
            const days = Math.floor(hours / 24);
            return days + 'å¤©å‰';
        }

        window.editRoute = function(key) {
            const config = cachedRoutes[key];
            if (!config) return;
            
            document.getElementById('routeKey').value = key;
            document.getElementById('url').value = config.url || '';
            document.getElementById('type').value = config.type || 'html';
            document.getElementById('itemSelector').value = config.itemSelector || '';
            document.getElementById('titleSelector').value = config.titleSelector || '';
            document.getElementById('linkSelector').value = config.linkSelector || '';
            document.getElementById('linkNeedJoin').checked = config.linkNeedJoin || false;
            document.getElementById('linkBaseUrl').value = config.linkBaseUrl || '';
            document.getElementById('linkBaseUrl').classList.toggle('hidden', !config.linkNeedJoin);
            document.getElementById('descSelector').value = config.descSelector || '';
            document.getElementById('dateSelector').value = config.dateSelector || '';
            document.getElementById('channelTitle').value = config.channelTitle || '';
            document.getElementById('channelDesc').value = config.channelDesc || '';
            document.getElementById('folder').value = config.folder || '';
            document.getElementById('maxItems').value = config.maxItems || 20;
            document.getElementById('encoding').value = config.encoding || 'auto';
            document.getElementById('fullText').checked = config.fullText || false;
            document.getElementById('fullTextSelector').value = config.fullTextSelector || '';
            document.getElementById('timestampMode').checked = config.timestampMode || false;
            document.getElementById('timestampUnit').value = config.timestampUnit || 'ms';
            document.getElementById('reverseOrder').checked = config.reverseOrder || false;
            
            // æ˜¾ç¤º/éšè—å…¨æ–‡é…ç½®
            if (config.fullText) {
                document.getElementById('fullTextConfig').classList.remove('hidden');
            } else {
                document.getElementById('fullTextConfig').classList.add('hidden');
            }
            
            // æ˜¾ç¤º/éšè—æ—¶é—´æˆ³é…ç½®
            if (config.timestampMode) {
                document.getElementById('timestampConfig').classList.remove('hidden');
            } else {
                document.getElementById('timestampConfig').classList.add('hidden');
            }
            
            updatePlaceholder(); // æ›´æ–°å ä½ç¬¦
            
            // é‡ç½®ä¸ºé¢„è§ˆæ¨¡å¼å¹¶åŠ è½½é¢„è§ˆ
            document.getElementById('previewTitle').textContent = 'å¯è§†åŒ–é¢„è§ˆ';
            document.getElementById('visualPreview').classList.remove('hidden');
            document.getElementById('testResult').classList.add('hidden');
            loadPreview();
            
            showPage('editor');
        };

        window.deleteRoute = async function(key) {
            if (!confirm('ç¡®å®šåˆ é™¤ ' + key + ' å—?')) return;
            await authFetch(API_BASE + '?key=' + key, { method: 'DELETE' });
            loadRoutes();
        };

        // --- Form & Test ---
        function getFormData() {
            return {
                key: document.getElementById('routeKey').value,
                config: {
                    url: document.getElementById('url').value,
                    type: document.getElementById('type').value,
                    itemSelector: document.getElementById('itemSelector').value,
                    titleSelector: document.getElementById('titleSelector').value,
                    linkSelector: document.getElementById('linkSelector').value,
                    linkNeedJoin: document.getElementById('linkNeedJoin').checked,
                    linkBaseUrl: document.getElementById('linkBaseUrl').value,
                    descSelector: document.getElementById('descSelector').value,
                    dateSelector: document.getElementById('dateSelector').value,
                    channelTitle: document.getElementById('channelTitle').value,
                    channelDesc: document.getElementById('channelDesc').value,
                    folder: document.getElementById('folder').value,
                    maxItems: parseInt(document.getElementById('maxItems').value) || 20,
                    encoding: document.getElementById('encoding').value,
                    fullText: document.getElementById('fullText').checked,
                    fullTextSelector: document.getElementById('fullTextSelector').value,
                    timestampMode: document.getElementById('timestampMode').checked,
                    timestampUnit: document.getElementById('timestampUnit').value,
                    reverseOrder: document.getElementById('reverseOrder').checked,
                }
            };
        }

        window.testRule = async function() {
            const data = getFormData();
            
            if (!data.config.url) {
                alert('è¯·å¡«å†™ URL');
                return;
            }
            
            // Telegram ç±»å‹ä¸éœ€è¦é€‰æ‹©å™¨
            if (data.config.type !== 'telegram' && !data.config.itemSelector) {
                // RSS ç±»å‹å¦‚æœæ²¡å¡«é€‰æ‹©å™¨ï¼Œåç«¯ä¼šè‡ªåŠ¨å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥æ”¾è¡Œ
                if (data.config.type === 'rss') {
                    // Do nothing, allow empty selector
                } else {
                    alert('è¯·å¡«å†™åˆ—è¡¨é€‰æ‹©å™¨');
                    return;
                }
            }

            // åˆ‡æ¢åˆ°æµ‹è¯•ç»“æœè§†å›¾
            document.getElementById('previewTitle').textContent = 'æµ‹è¯•ç»“æœ';
            document.getElementById('visualPreview').classList.add('hidden');
            document.getElementById('testResult').classList.remove('hidden');

            const testResult = document.getElementById('testResult');
            testResult.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';

            try {
                // Inject key into config for preview so fallbacks work
                const previewConfig = { ...data.config, key: data.key };
                const res = await authFetch(PREVIEW_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(previewConfig)
                });
                
                // Check for JSON response
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    // Try to extract error message from HTML if possible, or just show start of text
                    let errorMsg = 'Server returned non-JSON response';
                    if (text.includes('<title>')) {
                        const match = text.match(/<title>(.*?)<\/title>/);
                        if (match) errorMsg += ': ' + match[1];
                    }
                    throw new Error(errorMsg + ' (Check console for details)');
                }

                const result = await res.json();
                
                if (result.isError) {
                    testResult.innerHTML = `<div class="bg-red-50 p-4 rounded text-red-700 text-sm">${result.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                    return;
                }

                if (!result.items || result.items.length === 0) {
                    testResult.innerHTML = '<div class="text-center text-gray-500 py-10">æœªæ‰¾åˆ°ä»»ä½•æ¡ç›®ï¼Œè¯·æ£€æŸ¥é€‰æ‹©å™¨ã€‚</div>';
                    return;
                }

                const maxItems = data.config.maxItems || 20;
                const actualCount = result.items.length;
                const headerHtml = `
                    <div class="bg-green-50 border border-green-200 rounded-md p-3 mb-4 text-sm">
                        <span class="text-green-800 font-medium">âœ“ æˆåŠŸè·å– <strong>${actualCount}</strong> æ¡æ•°æ®</span>
                        <span class="text-gray-600 ml-2">(é…ç½®: ${maxItems} æ¡)</span>
                    </div>
                `;

                testResult.innerHTML = headerHtml + result.items.map(item => {
                    const desc = item.description || '';
                    const descLength = desc.length;
                    // Strip HTML tags for preview to prevent layout breakage due to unclosed tags in truncated text
                    const plainText = desc.replace(/<[^>]+>/g, '');
                    const descPreview = plainText.length > 300 ? plainText.substring(0, 300) + '...' : plainText;
                    
                    return `
                        <div class="border-l-4 border-blue-500 bg-gray-50 p-3 rounded shadow-sm text-sm mb-3">
                            <h4 class="font-bold text-gray-900 mb-1"><a href="${item.link || '#'}" target="_blank" class="hover:underline text-blue-600">${item.title || 'æ— æ ‡é¢˜'}</a></h4>
                            <div class="text-xs text-gray-500 mb-2">${item.pubDate || 'æ— æ—¥æœŸ'} ${descLength > 0 ? `| å†…å®¹é•¿åº¦: ${descLength} å­—ç¬¦` : ''}</div>
                            <div class="text-gray-700 text-sm prose prose-sm max-w-none" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;">
                                ${descPreview || '<span class="text-gray-400">æ— å†…å®¹</span>'}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Display debug logs at bottom of left panel if available
                if (result.logs && result.logs.length > 0) {
                    const debugSection = document.getElementById('debugLogs');
                    if (debugSection) {
                        debugSection.innerHTML = `
                            <div class="text-xs font-medium text-gray-700 mb-2">ğŸ“‹ è°ƒè¯•æ—¥å¿—:</div>
                            <div class="space-y-1 text-xs font-mono text-gray-600">
                                ${result.logs.map(log => `<div>${log}</div>`).join('')}
                            </div>
                        `;
                        debugSection.classList.remove('hidden');
                    }
                }

            } catch (e) {
                testResult.innerHTML = `<div class="bg-red-50 p-4 rounded text-red-700 text-sm">è¯·æ±‚å¤±è´¥: ${e.message}</div>`;
            }
        };

        document.getElementById('routeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = getFormData();
            
            document.getElementById('globalLoading').classList.remove('hidden');

            try {
                await authFetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                alert('âœ“ ä¿å­˜æˆåŠŸï¼ç¼“å­˜å·²è‡ªåŠ¨æ¸…é™¤ï¼Œç«‹å³ç”Ÿæ•ˆã€‚');
                loadRoutes(); // Refresh cache
                showPage('list'); // è·³è½¬åˆ°åˆ—è¡¨é¡µé¢
                // éšè—è°ƒè¯•æ—¥å¿—
                const debugSection = document.getElementById('debugLogs');
                if (debugSection) {
                    debugSection.classList.add('hidden');
                    debugSection.innerHTML = '';
                }
            } catch(e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            } finally {
                document.getElementById('globalLoading').classList.add('hidden');
            }
        });

        // --- Visual Selector ---
        let currentVisualMode = 'item';
        let currentPreviewMode = 'item';

        // é¢„è§ˆæ¨¡å¼åˆ‡æ¢å‡½æ•°
        window.setPreviewMode = function(mode) {
            currentPreviewMode = mode;
            const type = document.getElementById('type').value;
            
            // Update UI buttons
            document.querySelectorAll('#visualPreview .tool-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-300');
                btn.classList.add('bg-white', 'text-gray-700');
            });
            
            const btn = document.getElementById('preview-btn-' + mode);
            if (btn) {
                btn.classList.remove('bg-white', 'text-gray-700');
                btn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
            }

            // å‘é€æ¨¡å¼åˆ° iframeï¼ˆä»…åœ¨ HTML æ¨¡å¼ä¸‹ï¼‰
            if (type !== 'json') {
                const frame = document.getElementById('previewFrame');
                if (frame.contentWindow && frame.src) {
                    const itemSelector = document.getElementById('itemSelector').value;
                    frame.contentWindow.postMessage({ 
                        type: 'setMode', 
                        mode: mode,
                        selectorType: type,
                        itemSelector: itemSelector
                    }, '*');
                }
            }
        };

        // Simple XML to JSON converter for frontend visualization
        function xmlToJson(xml) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xml, "text/xml");
            
            function elementToObj(element) {
                const obj = {};
                // Attributes
                if (element.attributes && element.attributes.length > 0) {
                    for (let i = 0; i < element.attributes.length; i++) {
                        const attr = element.attributes[i];
                        obj['@' + attr.name] = attr.value;
                    }
                }
                
                // Children
                if (element.children.length === 0) {
                    const text = element.textContent.trim();
                    if (Object.keys(obj).length === 0) return text;
                    if (text) obj['#text'] = text;
                    return obj;
                }
                
                for (let i = 0; i < element.children.length; i++) {
                    const child = element.children[i];
                    const childName = child.tagName;
                    const childObj = elementToObj(child);
                    
                    if (obj[childName]) {
                        if (!Array.isArray(obj[childName])) {
                            obj[childName] = [obj[childName]];
                        }
                        obj[childName].push(childObj);
                    } else {
                        obj[childName] = childObj;
                    }
                }
                return obj;
            }
            
            const root = doc.documentElement;
            const result = {};
            if (root) {
                result[root.tagName] = elementToObj(root);
            }
            return result;
        }

        // åŠ è½½é¢„è§ˆé¡µé¢
        window.loadPreview = async function() {
            const url = document.getElementById('url').value;
            const type = document.getElementById('type').value;
            
            // ç¡®ä¿åˆ‡æ¢å›é¢„è§ˆæ¨¡å¼
            document.getElementById('previewTitle').textContent = 'å¯è§†åŒ–é¢„è§ˆ';
            document.getElementById('visualPreview').classList.remove('hidden');
            document.getElementById('testResult').classList.add('hidden');

            if (!url) {
                document.getElementById('previewFrame').src = '';
                document.getElementById('jsonPreview').innerHTML = '';
                return;
            }

            if (type === 'json' || type === 'rss') {
                // JSON/RSS Preview
                document.getElementById('previewFrame').classList.add('hidden');
                document.getElementById('previewToolbar').classList.remove('hidden'); // Show toolbar
                document.getElementById('jsonPreview').classList.remove('hidden');
                document.getElementById('jsonPreview').innerHTML = '<div class="text-center text-gray-400 py-10">åŠ è½½ä¸­...</div>';
                
                // Update toolbar labels
                document.getElementById('preview-btn-item').textContent = 'ğŸ“¦ åˆ—è¡¨æ•°ç»„';
                document.getElementById('preview-btn-title').textContent = 'ğŸ“ æ ‡é¢˜å­—æ®µ';
                document.getElementById('preview-btn-link').textContent = 'ğŸ”— é“¾æ¥å­—æ®µ';
                document.getElementById('preview-btn-desc').textContent = 'ğŸ“„ æè¿°å­—æ®µ';
                document.getElementById('preview-btn-date').textContent = 'ğŸ“… æ—¥æœŸå­—æ®µ';

                try {
                    // Use proxy to get raw content
                    const response = await authFetch(PROXY_JSON_API + '?url=' + encodeURIComponent(url));
                    let data;
                    if (type === 'rss') {
                        const text = await response.text();
                        data = xmlToJson(text);
                    } else {
                        data = await response.json();
                    }
                    renderJsonTree(data, '', 0, document.getElementById('jsonPreview'));
                } catch (e) {
                    document.getElementById('jsonPreview').innerHTML = '<div class="text-center text-red-400 py-10">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
                }
                return;
            } else if (type === 'telegram') {
                 document.getElementById('previewFrame').src = '';
                 document.getElementById('jsonPreview').innerHTML = '<div class="text-center text-gray-500 py-10">æ­¤ç±»å‹æ— éœ€å¯è§†åŒ–é€‰æ‹©å™¨ï¼Œè¯·ç›´æ¥ç‚¹å‡»"æµ‹è¯•è§„åˆ™"æŸ¥çœ‹ç»“æœ</div>';
                 document.getElementById('jsonPreview').classList.remove('hidden');
                 document.getElementById('previewFrame').classList.add('hidden');
                 document.getElementById('previewToolbar').classList.add('hidden');
                 return;
            }
            
            // HTML Preview
            document.getElementById('previewFrame').classList.remove('hidden');
            document.getElementById('previewToolbar').classList.remove('hidden');
            document.getElementById('jsonPreview').classList.add('hidden');

            // Reset toolbar labels for HTML
            document.getElementById('preview-btn-item').textContent = 'æ¡ç›®';
            document.getElementById('preview-btn-title').textContent = 'æ ‡é¢˜';
            document.getElementById('preview-btn-link').textContent = 'é“¾æ¥';
            document.getElementById('preview-btn-desc').textContent = 'æè¿°';
            document.getElementById('preview-btn-date').textContent = 'æ—¥æœŸ';
            
            const previewFrame = document.getElementById('previewFrame');
            previewFrame.src = PROXY_API + '?url=' + encodeURIComponent(url);
            
            // ç­‰å¾…åŠ è½½åè®¾ç½®æ¨¡å¼
            setTimeout(() => setPreviewMode(currentPreviewMode), 500);
        };

        window.updatePlaceholder = function() {
            const type = document.getElementById('type').value;
            const itemInput = document.getElementById('itemSelector');
            const titleInput = document.getElementById('titleSelector');
            const linkInput = document.getElementById('linkSelector');
            const descInput = document.getElementById('descSelector');
            const dateInput = document.getElementById('dateSelector');
            
            // å¦‚æœæ˜¯ Telegram ç±»å‹ï¼Œéšè—é€‰æ‹©å™¨é…ç½®ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰
            const selectorSection = document.getElementById('section-selectors');
            if (type === 'telegram') {
                selectorSection.style.display = 'none';
                itemInput.removeAttribute('required');
                // æ¸…ç©ºé€‰æ‹©å™¨ï¼ˆåç«¯ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
                itemInput.value = '';
                titleInput.value = '';
                linkInput.value = '';
                descInput.value = '';
                dateInput.value = '';
            } else {
                selectorSection.style.display = 'block';
                itemInput.setAttribute('required', 'required');
                
                if (type === 'xpath') {
                    itemInput.placeholder = '//div[@class="list-item"]';
                    titleInput.placeholder = './/h2/a';
                    linkInput.placeholder = './/a/@href';
                    descInput.placeholder = './/div[@class="desc"]';
                    dateInput.placeholder = './/span[@class="date"]';
                } else if (type === 'json' || type === 'rss') {
                    itemInput.placeholder = 'data.items (å¦‚æœæ•´ä¸ªå“åº”æ˜¯æ•°ç»„å¯ç•™ç©º)';
                    titleInput.placeholder = 'title æˆ– æ¨¡æ¿:ç»¼åˆåˆ†ä½:{indexValue}';
                    linkInput.placeholder = 'url æˆ– æ¨¡æ¿:https://site.com/{id}';
                    descInput.placeholder = 'content æˆ– æ¨¡æ¿:è¯¦æƒ…:{description}';
                    dateInput.placeholder = 'publishTime (æˆ– created_at)';
                } else {
                    itemInput.placeholder = '.post-item';
                    titleInput.placeholder = 'h2 a';
                    linkInput.placeholder = 'a';
                    descInput.placeholder = '.summary';
                    dateInput.placeholder = '.date';
                }
            }
        };

        window.addEventListener('message', (e) => {
            if (e.data.type === 'selected') {
                const { mode, selector } = e.data;
                
                if (mode === 'item') {
                    document.getElementById('itemSelector').value = selector;
                } else if (mode === 'title') {
                    document.getElementById('titleSelector').value = selector;
                } else if (mode === 'link') {
                    document.getElementById('linkSelector').value = selector;
                } else if (mode === 'desc') {
                    document.getElementById('descSelector').value = selector;
                } else if (mode === 'date') {
                    document.getElementById('dateSelector').value = selector;
                }
            }
        });

        // ===== JSON é€‰æ‹©å™¨åŠŸèƒ½ =====
        
        function renderJsonTree(data, path = '', level = 0, container = null) {
            const viewer = container || document.getElementById('jsonPreview');
            if (level === 0) viewer.innerHTML = '';
            
            const indent = '  '.repeat(level);
            const isArray = Array.isArray(data);
            const isObject = typeof data === 'object' && data !== null && !isArray;
            
            if (isArray) {
                const arrayPath = path || ''; // Root array path is empty string or just use what is passed
                
                const el = document.createElement('div');
                el.className = 'cursor-pointer hover:bg-gray-800 px-1';
                el.title = 'ç‚¹å‡»é€‰æ‹©æ­¤æ•°ç»„: ' + (arrayPath || 'root');
                el.innerHTML = indent + '<span class="text-gray-500">[</span> <span class="text-yellow-400 text-xs">(æ•°ç»„ï¼Œå…±' + data.length + 'é¡¹)</span>';
                
                // æ•°ç»„å¼€å§‹æ‹¬å·å¯ç‚¹å‡»
                el.onclick = function(e) {
                    e.stopPropagation();
                    if (currentPreviewMode === 'item') {
                        selectJsonPath(arrayPath);
                    }
                };
                
                viewer.appendChild(el);
                
                // åªæ˜¾ç¤ºå‰3ä¸ªå…ƒç´ 
                const itemsToShow = Math.min(3, data.length);
                for (let i = 0; i < itemsToShow; i++) {
                    renderJsonTree(data[i], path + '[' + i + ']', level + 1, viewer);
                }
                
                if (data.length > 3) {
                    const moreEl = document.createElement('div');
                    moreEl.className = 'text-gray-500';
                    moreEl.innerHTML = indent + '  <span class="italic">... è¿˜æœ‰ ' + (data.length - 3) + ' é¡¹</span>';
                    viewer.appendChild(moreEl);
                }
                
                const closeEl = document.createElement('div');
                closeEl.className = 'cursor-pointer hover:bg-gray-800 px-1';
                closeEl.title = 'ç‚¹å‡»é€‰æ‹©æ­¤æ•°ç»„: ' + (arrayPath || 'root');
                closeEl.innerHTML = indent + '<span class="text-gray-500">]</span>';
                
                // é—­åˆæ‹¬å·ä¹Ÿå¯ç‚¹å‡»
                closeEl.onclick = function(e) {
                    e.stopPropagation();
                    if (currentPreviewMode === 'item') {
                        selectJsonPath(arrayPath);
                    }
                };
                
                viewer.appendChild(closeEl);
            } else if (isObject) {
                const el = document.createElement('div');
                el.innerHTML = indent + '<span class="text-gray-500">{</span>';
                viewer.appendChild(el);
                
                for (const key in data) {
                    const value = data[key];
                    const currentPath = path ? path + '.' + key : key;
                    const valueType = Array.isArray(value) ? 'array' : typeof value;
                    
                    if (valueType === 'object' || valueType === 'array') {
                        const keyEl = document.createElement('div');
                        
                        // å¦‚æœæ˜¯æ•°ç»„ï¼Œè®©keyä¹Ÿå¯ä»¥ç‚¹å‡»
                        if (valueType === 'array') {
                            keyEl.className = 'cursor-pointer hover:bg-gray-800 px-1';
                            keyEl.title = 'ç‚¹å‡»é€‰æ‹©æ­¤æ•°ç»„: ' + currentPath;
                            keyEl.innerHTML = indent + '  <span class="text-blue-400">"' + key + '"</span>: <span class="text-yellow-400 text-xs">[æ•°ç»„]</span>';
                            keyEl.onclick = function(e) {
                                e.stopPropagation();
                                if (currentPreviewMode === 'item') {
                                    selectJsonPath(currentPath);
                                }
                            };
                        } else {
                            keyEl.innerHTML = indent + '  <span class="text-blue-400">"' + key + '"</span>: ';
                        }
                        
                        viewer.appendChild(keyEl);
                        renderJsonTree(value, currentPath, level + 1, viewer);
                    } else {
                        const lineEl = document.createElement('div');
                        lineEl.className = 'cursor-pointer hover:bg-gray-800 px-1';
                        lineEl.title = 'ç‚¹å‡»é€‰æ‹©: ' + currentPath;
                        
                        let displayValue = JSON.stringify(value);
                        if (displayValue.length > 50) displayValue = displayValue.substring(0, 50) + '...';
                        
                        let color = 'text-green-400';
                        if (valueType === 'number') color = 'text-yellow-400';
                        else if (valueType === 'boolean') color = 'text-purple-400';
                        else if (value === null) color = 'text-gray-500';
                        
                        lineEl.innerHTML = indent + '  <span class="text-blue-400">"' + key + '"</span>: <span class="' + color + '">' + displayValue + '</span>,';
                        
                        lineEl.onclick = function(e) {
                            e.stopPropagation();
                            if (currentPreviewMode !== 'item') {
                                selectJsonPath(key);
                            }
                        };
                        
                        viewer.appendChild(lineEl);
                    }
                }
                
                const closeEl = document.createElement('div');
                closeEl.innerHTML = indent + '<span class="text-gray-500">}</span>';
                viewer.appendChild(closeEl);
            } else {
                // åŸºæœ¬ç±»å‹
                const el = document.createElement('div');
                el.innerHTML = indent + '<span class="text-green-400">' + JSON.stringify(data) + '</span>';
                viewer.appendChild(el);
            }
        }

        function selectJsonPath(path) {
            // è·å–å½“å‰æ¨¡å¼å¯¹åº”çš„è¾“å…¥æ¡†ID
            let inputId = '';
            if (currentPreviewMode === 'item') inputId = 'itemSelector';
            else if (currentPreviewMode === 'title') inputId = 'titleSelector';
            else if (currentPreviewMode === 'link') inputId = 'linkSelector';
            else if (currentPreviewMode === 'desc') inputId = 'descSelector';
            else if (currentPreviewMode === 'date') inputId = 'dateSelector';
            
            if (!inputId) return;
            
            const inputEl = document.getElementById(inputId);
            if (!inputEl) return;

            // å¦‚æœæ˜¯åˆ—è¡¨é¡¹æ¨¡å¼ï¼Œç›´æ¥æ›¿æ¢
            if (currentPreviewMode === 'item') {
                inputEl.value = path;
                // é«˜äº®ä¸€ä¸‹è¡¨ç¤ºæˆåŠŸ
                inputEl.classList.add('bg-green-50');
                setTimeout(() => inputEl.classList.remove('bg-green-50'), 500);
            } else {
                // å…¶ä»–æ¨¡å¼æ”¯æŒæ¨¡æ¿æ’å…¥
                const currentVal = inputEl.value;
                const insertVal = '{' + path + '}';
                
                if (!currentVal) {
                    inputEl.value = path; // å¦‚æœä¸ºç©ºï¼Œç›´æ¥å¡«è·¯å¾„ï¼ˆå…¼å®¹éæ¨¡æ¿æ¨¡å¼ï¼‰
                } else {
                    // æ’å…¥åˆ°å…‰æ ‡ä½ç½®
                    const start = inputEl.selectionStart;
                    const end = inputEl.selectionEnd;
                    const newVal = currentVal.substring(0, start) + insertVal + currentVal.substring(end);
                    inputEl.value = newVal;
                    
                    // æ¢å¤å…‰æ ‡ä½ç½®
                    setTimeout(() => {
                        inputEl.selectionStart = inputEl.selectionEnd = start + insertVal.length;
                        inputEl.focus();
                    }, 0);
                }
                
                // é«˜äº®ä¸€ä¸‹
                inputEl.classList.add('bg-green-50');
                setTimeout(() => inputEl.classList.remove('bg-green-50'), 500);
            }
        }

        // Init
        checkAuth();
        
        // ç™»å½•è¡¨å•å¤„ç†
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            try {
                const response = await fetch('/admin/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    sessionStorage.setItem('adminToken', data.token);
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadRoutes();
                } else {
                    errorEl.textContent = 'å¯†ç é”™è¯¯ï¼';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                errorEl.textContent = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
                errorEl.classList.remove('hidden');
            }
        });
        
        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            const token = sessionStorage.getItem('adminToken');
            
            try {
                const response = await fetch('/admin/check', {
                    headers: { 'Authorization': 'Bearer ' + (token || '') }
                });
                
                if (response.ok) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadRoutes();
                } else {
                    document.getElementById('loginPage').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('loginPage').classList.remove('hidden');
            }
        }
        
        // æ·»åŠ è®¤è¯å¤´åˆ°æ‰€æœ‰APIè¯·æ±‚
        async function authFetch(url, options = {}) {
            const token = sessionStorage.getItem('adminToken');
            options.headers = options.headers || {};
            options.headers['Authorization'] = 'Bearer ' + (token || '');
            
            const response = await fetch(url, options);
            
            // å¦‚æœ401æœªæˆæƒï¼Œé‡æ–°æ˜¾ç¤ºç™»å½•é¡µé¢
            if (response.status === 401) {
                sessionStorage.removeItem('adminToken');
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                throw new Error('æœªæˆæƒ');
            }
            
            return response;
        }
        
        // å…¨æ–‡æŠ“å–å¤é€‰æ¡†æ§åˆ¶
        document.getElementById('fullText').addEventListener('change', (e) => {
            const fullTextConfig = document.getElementById('fullTextConfig');
            if (e.target.checked) {
                fullTextConfig.classList.remove('hidden');
            } else {
                fullTextConfig.classList.add('hidden');
            }
        });
        
        // æ—¶é—´æˆ³æ¨¡å¼æ§åˆ¶
        document.getElementById('timestampMode').addEventListener('change', (e) => {
            const timestampConfig = document.getElementById('timestampConfig');
            if (e.target.checked) {
                timestampConfig.classList.remove('hidden');
            } else {
                timestampConfig.classList.add('hidden');
            }
        });
        
        document.getElementById('routeKey').addEventListener('input', (e) => {
             // This is just for the old code compatibility if needed, but we use a new UI now.
             // The new UI doesn't use this specific ID for preview text in the same way, 
             // but let's keep it clean.
        });
        
        // URL è¾“å…¥æ¡†å˜åŒ–æ—¶è‡ªåŠ¨åŠ è½½é¢„è§ˆ
        let urlLoadTimeout;
        document.getElementById('url').addEventListener('input', (e) => {
            clearTimeout(urlLoadTimeout);
            urlLoadTimeout = setTimeout(() => {
                const url = e.target.value;
                if (url && url.startsWith('http')) {
                    loadPreview();
                }
            }, 1000); // 1ç§’å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹åŠ è½½
        });
        
        // ç±»å‹é€‰æ‹©å™¨å˜åŒ–æ—¶æ›´æ–°å ä½ç¬¦å¹¶é‡æ–°åŠ è½½é¢„è§ˆ
        document.getElementById('type').addEventListener('change', () => {
            updatePlaceholder();
            loadPreview();
        });
