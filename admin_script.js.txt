const API_BASE = '/api/routes';
        const PREVIEW_API = '/api/preview';
        const PROXY_API = '/api/visual-proxy';
        const PROXY_JSON_API = '/api/proxy';

    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

        // --- Navigation ---
        function showPage(pageId) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page-' + pageId).classList.remove('hidden');
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.nav-btn').forEach(el => {
                if (el.dataset.target === pageId) {
                    el.classList.add('active', 'bg-blue-600', 'text-white');
                    el.classList.remove('text-gray-900', 'font-medium', 'hover:bg-gray-100');
                } else {
                    el.classList.remove('active', 'bg-blue-600', 'text-white');
                    el.classList.add('text-gray-900', 'font-medium', 'hover:bg-gray-100');
                }
            });

            // é¡µé¢ç‰¹å®šé€»è¾‘
            if (pageId === 'list') {
                loadRoutes();
            } else if (pageId === 'folders') {
                loadFolders();
            } else if (pageId === 'domains') {
                loadDomains();
            } else if (pageId === 'dashboard') {
                updateStats();
            } else if (pageId === 'editor') {
                // å¦‚æœæ˜¯æ–°å»ºè·¯ç”±ï¼ˆéç¼–è¾‘ï¼‰ï¼Œé‡ç½®è¡¨å•
                const routeKey = document.getElementById('routeKey').value;
                if (!routeKey || !cachedRoutes[routeKey]) {
                    resetForm();
                } else {
                    // ç¼–è¾‘æ¨¡å¼ä¹Ÿéšè—è°ƒè¯•æ—¥å¿—
                    const debugSection = document.getElementById('debugLogs');
                    if (debugSection) {
                        debugSection.classList.add('hidden');
                    }
                }
            }

            // æ›´æ–°æµè§ˆå™¨ URL çš„ ?tab= å‚æ•°ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰ï¼Œä¾¿äºåˆ†äº«æˆ–ç›´æ¥è®¿é—®
            try {
                const u = new URL(location.href);
                u.searchParams.set('tab', pageId);
                // ä½¿ç”¨ replaceState é¿å…äº§ç”Ÿå¤šæ¡å†å²è®°å½•ï¼›ç”¨æˆ·ä¹Ÿå¯ä»¥æ‰‹åŠ¨åé€€
                history.replaceState(null, '', u.pathname + (u.search ? '?' + u.searchParams.toString() : '') + (u.hash || ''));
            } catch (e) {
                // ignore
            }
        }

        // Support hash links so /admin#editor opens editor directly
        window.addEventListener('DOMContentLoaded', () => {
            // 1) ä¼˜å…ˆæ”¯æŒæŸ¥è¯¢å‚æ•° ?tab=editor
            const params = new URLSearchParams(location.search || '');
            const tab = params.get('tab');
            if (tab) {
                try { showPage(tab); return; } catch (e) { /* fallthrough */ }
            }

            // 2) å…¶æ¬¡æ”¯æŒ hashï¼Œå¦‚ /admin#editor
            const h = (location.hash || '').replace('#', '').trim();
            if (h) {
                try { showPage(h); } catch (e) { showPage('dashboard'); }
            } else {
                showPage('dashboard');
            }
        });

        // Handle user changing the hash (clicking anchor links or browser back/forward)
        window.addEventListener('hashchange', () => {
            const h = (location.hash || '').replace('#', '').trim();
            if (h) {
                try { showPage(h); } catch (e) { /* ignore invalid hash */ }
            }
        });

        function resetForm() {
            document.getElementById('routeForm').reset();
            // é‡ç½®ä¸ºé¢„è§ˆæ¨¡å¼
            document.getElementById('previewTitle').textContent = 'å¯è§†åŒ–é¢„è§ˆ';
            document.getElementById('visualPreview').classList.remove('hidden');
            document.getElementById('testResult').classList.add('hidden');
            document.getElementById('previewFrame').src = '';
            document.getElementById('usePuppeteer').checked = false;
            // éšè—è°ƒè¯•æ—¥å¿—
            const debugSection = document.getElementById('debugLogs');
            if (debugSection) {
                debugSection.classList.add('hidden');
                debugSection.innerHTML = '';
            }
        }

        // --- Data Logic ---
        let cachedRoutes = {};
        let isSniffing = false;

        async function loadRoutes() {
            const listEl = document.getElementById('routeList');
            listEl.innerHTML = '<li class="p-4 text-center text-gray-500">åŠ è½½ä¸­...</li>';
            
            try {
                const res = await authFetch(API_BASE);
                cachedRoutes = await res.json();
                renderList();
                updateStats();
            } catch (e) {
                listEl.innerHTML = '<li class="p-4 text-center text-red-500">åŠ è½½å¤±è´¥: ' + e.message + '</li>';
            }
        }

        async function loadFolders() {
            const listEl = document.getElementById('folderList');
            listEl.innerHTML = '<div class="col-span-full p-4 text-center text-gray-500">åŠ è½½ä¸­...</div>';
            
            try {
                // Always fetch fresh data
                const res = await authFetch(API_BASE);
                cachedRoutes = await res.json();
                renderFolders();
            } catch (e) {
                listEl.innerHTML = '<div class="col-span-full p-4 text-center text-red-500">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
            }
        }

        function renderFolders() {
            const listEl = document.getElementById('folderList');
            
            // Group by folder
            const folders = {};
            Object.entries(cachedRoutes).forEach(([key, config]) => {
                if (config.folder) {
                    if (!folders[config.folder]) {
                        folders[config.folder] = {
                            name: config.folder,
                            count: 0,
                            routes: [],
                            lastUpdate: 0
                        };
                    }
                    folders[config.folder].count++;
                    folders[config.folder].routes.push(key);
                    if (config.status && config.status.lastUpdate > folders[config.folder].lastUpdate) {
                        folders[config.folder].lastUpdate = config.status.lastUpdate;
                    }
                }
            });
            
            const folderKeys = Object.keys(folders).sort();
            
            if (folderKeys.length === 0) {
                listEl.innerHTML = '<div class="col-span-full p-6 text-center text-gray-500 text-sm">æš‚æ— åˆé›†ï¼Œè¯·åœ¨ç¼–è¾‘è·¯ç”±æ—¶è®¾ç½®"æ–‡ä»¶å¤¹"å­—æ®µ</div>';
                return;
            }
            
            listEl.innerHTML = '';
            
            folderKeys.forEach(key => {
                const folder = folders[key];
                const li = document.createElement('div');
                li.className = 'bg-white rounded-lg shadow border border-gray-200 hover:shadow-md transition-shadow flex flex-col';
                // ä¿æŒå¡ç‰‡ä¸º 3:2 é•¿å®½æ¯”ï¼Œç°ä»£æµè§ˆå™¨æ”¯æŒ aspect-ratio
                try { li.style.aspectRatio = '3 / 2'; } catch (e) { /* ignore */ }
                li.innerHTML = `
                    <div class="p-4 flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-gray-900 truncate" title="${folder.name}">ğŸ“‚ ${folder.name}</h3>
                            <span class="badge bg-purple-100 text-purple-700 text-xs">${folder.count} ä¸ªè·¯ç”±</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3 line-clamp-2" title="${folder.routes.join(', ')}">åŒ…å«: ${folder.routes.join(', ')}</p>
                        ${folder.lastUpdate ? 
                            `<p class="text-xs text-gray-400">æœ€è¿‘æ›´æ–°: ${timeAgo(folder.lastUpdate)}</p>` 
                            : '<p class="text-xs text-gray-400">æš‚æ— æ›´æ–°è®°å½•</p>'}
                    </div>
                    <div class="bg-gray-50 px-4 py-3 border-t border-gray-100 flex items-center justify-between rounded-b-lg">
                        <div class="flex gap-2">
                            <a href="/?folder=${encodeURIComponent(folder.name)}&format=rss" target="_blank" class="text-orange-500 hover:text-orange-600 flex items-center gap-1 text-xs font-medium">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                                RSS
                            </a>
                            <a href="/?folder=${encodeURIComponent(folder.name)}&format=atom" target="_blank" class="text-blue-500 hover:text-blue-600 flex items-center gap-1 text-xs font-medium">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                Atom
                            </a>
                            <a href="/?folder=${encodeURIComponent(folder.name)}&format=json" target="_blank" class="text-green-500 hover:text-green-600 flex items-center gap-1 text-xs font-medium">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                JSON
                            </a>
                        </div>
                        <button onclick="openFolderModal('${folder.name}')" class="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            ç¼–è¾‘
                        </button>
                    </div>
                `;
                // å¼ºåˆ¶å¡ç‰‡ä¸º flex åˆ—å¸ƒå±€ï¼Œä¿æŒæ¯”ä¾‹æ—¶å†…éƒ¨å¯æ­£ç¡®æ”¶ç¼©
                li.style.display = 'flex';
                li.style.flexDirection = 'column';
                li.style.justifyContent = 'space-between';
                li.style.overflow = 'hidden';
                // å†…å®¹åŒºéœ€è¦å¯æ”¶ç¼©ï¼Œé¿å…è¶…å‡ºçˆ¶å®¹å™¨å¯¼è‡´é«˜åº¦ç ´å
                const contentArea = li.querySelector('.p-4');
                if (contentArea) {
                    contentArea.style.overflow = 'hidden';
                    contentArea.style.minHeight = '0';
                    contentArea.style.display = 'flex';
                    contentArea.style.flexDirection = 'column';
                    contentArea.style.justifyContent = 'space-between';
                }
                listEl.appendChild(li);
            });
        }

        // --- Domain Config Logic ---
        async function loadDomains() {
            const input = document.getElementById('domainGroupsInput');
            const barkInput = document.getElementById('barkUrl');
            const puppeteerInput = document.getElementById('puppeteerUrl');
            const activeSelect = document.getElementById('activeRemarkSelect');
            
            input.value = 'åŠ è½½ä¸­...';
            input.disabled = true;
            if (barkInput) barkInput.disabled = true;
            if (puppeteerInput) puppeteerInput.disabled = true;
            if (activeSelect) activeSelect.disabled = true;
            
            try {
                const res = await authFetch('/api/domains');
                const config = await res.json();

                // Expose domain config globally for updateStats to use
                window.domainConfig = config || {};

                // Render textarea lines. If groupLabels exists, render as "label: a,b,c"
                if (config.groups && Array.isArray(config.groups)) {
                    const labels = Array.isArray(config.groupLabels) ? config.groupLabels : [];
                    const lines = config.groups.map((g, idx) => {
                        const label = labels[idx];
                        const domains = Array.isArray(g) ? g.join(', ') : (g || '');
                        return label ? `${label}: ${domains}` : domains;
                    });
                    input.value = lines.join('\n');
                } else {
                    input.value = '';
                }
                
                if (barkInput) {
                    barkInput.value = config.notifications?.barkUrl || '';
                }
                if (puppeteerInput) {
                    puppeteerInput.value = config.puppeteerUrl || '';
                }

                // Populate active remark select if labels exist
                if (activeSelect) {
                    activeSelect.innerHTML = '';
                    const labels = Array.isArray(config.groupLabels) ? config.groupLabels : [];
                    if (labels.length > 0) {
                        labels.forEach(label => {
                            const opt = document.createElement('option');
                            opt.value = label;
                            opt.textContent = label;
                            activeSelect.appendChild(opt);
                        });
                        // choose saved activeRemark or first label
                        const toSelect = config.activeRemark && labels.includes(config.activeRemark) ? config.activeRemark : labels[0];
                        activeSelect.value = toSelect;
                        activeSelect.onchange = () => updateStats();
                        activeSelect.parentElement.style.display = '';
                    } else {
                        activeSelect.parentElement.style.display = 'none';
                    }
                }

                // Load per-route Bark list
                try {
                    await loadBarkRouteList();
                } catch (e) {
                    console.warn('Failed to load Bark route list:', e);
                }
            } catch (e) {
                alert('åŠ è½½åŸŸåé…ç½®å¤±è´¥: ' + e.message);
                input.value = '';
            } finally {
                input.disabled = false;
                if (barkInput) barkInput.disabled = false;
                if (puppeteerInput) puppeteerInput.disabled = false;
                if (activeSelect) activeSelect.disabled = false;
            }
        }

        async function loadBarkRouteList() {
            const container = document.getElementById('barkRouteList');
            const statusEl = document.getElementById('barkRouteStatus');
            if (!container) return;
            container.innerHTML = '<div class="text-sm text-gray-500 p-2">åŠ è½½ä¸­...</div>';
            statusEl && (statusEl.textContent = '');
            try {
                const res = await authFetch(API_BASE);
                const routes = await res.json();
                // routes is an object mapping key->config
                const keys = Object.keys(routes).sort();
                if (keys.length === 0) {
                    container.innerHTML = '<div class="text-sm text-gray-500 p-2">æš‚æ— è·¯ç”±</div>';
                    return;
                }

                container.innerHTML = keys.map(key => {
                    // Default: if not explicitly set, treat as enabled (é»˜è®¤å¯ç”¨)
                    const raw = routes[key].notifications && Object.prototype.hasOwnProperty.call(routes[key].notifications, 'barkEnabled') ? routes[key].notifications.barkEnabled : undefined;
                    const enabled = (typeof raw === 'boolean') ? raw : true;
                    // Mark visually if explicitly set (optional)
                    return `<label class="flex items-center gap-2 p-1 text-sm"><input type="checkbox" data-key="${key}" ${enabled ? 'checked' : ''}> <span class="truncate">${key} â€” ${routes[key].url || ''}${raw === undefined ? '' : (raw ? ' (å·²æ˜¾å¼å¯ç”¨)' : ' (å·²æ˜¾å¼ç¦ç”¨)')}</span></label>`;
                }).join('');
            } catch (e) {
                container.innerHTML = '<div class="text-sm text-red-500 p-2">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
                statusEl && (statusEl.textContent = 'åŠ è½½å¤±è´¥');
            }
        }

        async function saveBarkSelections() {
            const container = document.getElementById('barkRouteList');
            const statusEl = document.getElementById('barkRouteStatus');
            if (!container) return;
            const checks = Array.from(container.querySelectorAll('input[type=checkbox]'));
            const updates = {};
            // Fetch latest routes to merge
            let routes = {};
            try {
                const res = await authFetch(API_BASE);
                routes = await res.json();
            } catch (e) {
                statusEl && (statusEl.textContent = 'è·å–æœ€æ–°è·¯ç”±å¤±è´¥: ' + e.message);
                return;
            }

            checks.forEach(cb => {
                const key = cb.dataset.key;
                if (!routes[key]) return;
                const cfg = routes[key];
                const rawPrev = cfg.notifications && Object.prototype.hasOwnProperty.call(cfg.notifications, 'barkEnabled') ? cfg.notifications.barkEnabled : undefined;
                const effectivePrev = (typeof rawPrev === 'boolean') ? rawPrev : true; // default enabled if not set
                const now = !!cb.checked;
                if (effectivePrev !== now) {
                    // Only write when effective previous differs from now
                    const newCfg = { ...cfg, notifications: { ...(cfg.notifications || {}), barkEnabled: now } };
                    updates[key] = newCfg;
                }
            });

            if (Object.keys(updates).length === 0) {
                statusEl && (statusEl.textContent = 'æœªå‘ç°æ›´æ”¹');
                setTimeout(() => statusEl && (statusEl.textContent = ''), 3000);
                return;
            }

            statusEl && (statusEl.textContent = 'æ­£åœ¨ä¿å­˜...');
            try {
                const res = await authFetch(API_BASE, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                if (res.ok) {
                    statusEl && (statusEl.textContent = 'ä¿å­˜æˆåŠŸ');
                    // Refresh list
                    await loadBarkRouteList();
                } else {
                    const txt = await res.text();
                    statusEl && (statusEl.textContent = 'ä¿å­˜å¤±è´¥: ' + txt);
                }
            } catch (e) {
                statusEl && (statusEl.textContent = 'ä¿å­˜å¤±è´¥: ' + e.message);
            }
            setTimeout(() => statusEl && (statusEl.textContent = ''), 4000);
        }

        function selectAllBark() {
            const container = document.getElementById('barkRouteList');
            if (!container) return;
            Array.from(container.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
        }

        function deselectAllBark() {
            const container = document.getElementById('barkRouteList');
            if (!container) return;
            Array.from(container.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = false);
        }

        async function saveDomains() {
            const input = document.getElementById('domainGroupsInput');
            const barkInput = document.getElementById('barkUrl');
            const puppeteerInput = document.getElementById('puppeteerUrl');
            const activeSelect = document.getElementById('activeRemarkSelect');
            const text = input.value || '';

            const groups = [];
            const groupLabels = [];

            text.split('\n').forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                // Try to parse "label: a,b,c" or "labelï¼ša,b,c"
                const m = trimmed.match(/^([^:ï¼š]+)[:ï¼š]\s*(.*)$/);
                if (m) {
                    const label = m[1].trim();
                    const rest = m[2].trim();
                    const items = rest.split(',').map(s => s.trim()).filter(s => s);
                    if (items.length > 0) {
                        groups.push(items);
                        groupLabels.push(label);
                    }
                } else {
                    // No label, just domains list
                    const items = trimmed.split(',').map(s => s.trim()).filter(s => s);
                    if (items.length > 0) {
                        groups.push(items);
                        groupLabels.push('');
                    }
                }
            });

            const notifications = {
                barkUrl: barkInput ? barkInput.value.trim() : ''
            };

            const payload = { 
                groups, 
                notifications,
                puppeteerUrl: puppeteerInput ? puppeteerInput.value.trim() : '' 
            };
            if (groupLabels.some(l => l)) payload.groupLabels = groupLabels;
            if (activeSelect && activeSelect.value) payload.activeRemark = activeSelect.value;

            try {
                const res = await authFetch('/api/domains', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert('ä¿å­˜æˆåŠŸ');
                } else {
                    throw new Error(await res.text());
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        async function testBark() {
            const barkInput = document.getElementById('barkUrl');
            const statusEl = document.getElementById('testBarkStatus');
            if (!barkInput) return;
            const barkUrl = barkInput.value.trim();
            statusEl.textContent = 'æ­£åœ¨å‘é€æµ‹è¯•é€šçŸ¥...';
            try {
                const res = await authFetch('/api/test-bark', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ barkUrl })
                });
                const data = await res.json();
                if (res.ok && data.ok) {
                    statusEl.textContent = 'æµ‹è¯•é€šçŸ¥å‘é€æˆåŠŸ (è¯·æ£€æŸ¥ä½ çš„è®¾å¤‡)';
                } else {
                    statusEl.textContent = 'å‘é€å¤±è´¥: ' + (data.error || await res.text());
                }
            } catch (e) {
                statusEl.textContent = 'è¯·æ±‚å¤±è´¥: ' + e.message;
            }
            setTimeout(() => { statusEl.textContent = 'ï¼ˆç‚¹å‡»å‘é€ä¸€æ¡æµ‹è¯•é€šçŸ¥åˆ°é…ç½®çš„ Bark URLï¼‰'; }, 5000);
        }

        function renderList() {
            const listEl = document.getElementById('routeList');
            listEl.innerHTML = '';
            listEl.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 p-4'; // æ¯è¡Œåœ¨å¤§å±æ˜¾ç¤º 6 ä¸ª
            
            const keys = Object.keys(cachedRoutes).reverse(); // Reverse order
            if (keys.length === 0) {
                listEl.innerHTML = '<div class="col-span-full p-6 text-center text-gray-500 text-sm">æš‚æ— è·¯ç”±ï¼Œè¯·å‰å¾€ç¼–è¾‘å™¨æ·»åŠ </div>';
                return;
            }

            keys.forEach(key => {
                const config = cachedRoutes[key];
                const li = document.createElement('div'); // Change to div
                li.className = 'bg-white rounded-lg shadow border border-gray-200 hover:shadow-md transition-shadow flex flex-col';
                // ä¿æŒå¡ç‰‡ä¸º 4:3 é•¿å®½æ¯”
                try { li.style.aspectRatio = '4 / 3'; } catch (e) { /* ignore */ }
                li.innerHTML = `
                    <div class="p-4 flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-base font-semibold text-gray-900 truncate" title="${key}">${key}</h3>
                            <div class="flex gap-1">
                                ${config.folder ? `<span class="badge bg-purple-50 text-purple-700 text-xs" title="æ–‡ä»¶å¤¹: ${config.folder}">${config.folder}</span>` : ''}
                                <span class="badge bg-gray-100 text-gray-700 text-xs">${config.type || 'html'}</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 truncate mb-3" title="${config.url}">${config.url}</p>
                        <div class="flex flex-wrap gap-1 mb-3">
                            <span class="badge bg-blue-50 text-blue-700 text-xs">${config.maxItems || 20} æ¡</span>
                            ${config.fullText ? '<span class="badge bg-orange-50 text-orange-700 text-xs">å…¨æ–‡</span>' : ''}
                            ${config.notifications && config.notifications.barkEnabled ? '<span class="badge bg-yellow-50 text-yellow-700 text-xs" title="Bark é€šçŸ¥å·²å¯ç”¨">Bark</span>' : ''}
                            ${config.status && config.status.lastUpdate ? 
                                `<span class="badge bg-green-50 text-green-700 text-xs" title="å†…å®¹æ›´æ–°äº: ${new Date(config.status.lastUpdate).toLocaleString()}">å†…å®¹æ›´æ–°: ${timeAgo(config.status.lastUpdate)}</span>` 
                                : ''}
                        </div>
                        <p class="text-xs text-gray-400 mb-2">é…ç½®æ›´æ–°äº: ${config.updatedAt ? new Date(config.updatedAt).toLocaleString() : 'æœªçŸ¥'}</p>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 border-t border-gray-100 flex items-center justify-between rounded-b-lg">
                        <div class="flex gap-2">
                            <a href="/?custom=${key}.rss" target="_blank" class="text-orange-500 hover:text-orange-600" title="RSS">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                            </a>
                            <a href="/?custom=${key}.atom" target="_blank" class="text-blue-500 hover:text-blue-600" title="Atom">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            </a>
                            <a href="/?custom=${key}.json" target="_blank" class="text-green-500 hover:text-green-600" title="JSON">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            </a>
                        </div>
                        <div class="flex gap-2">
                            <button onclick='editRoute("${key}")' class="text-xs text-blue-600 hover:text-blue-800 font-medium">ç¼–è¾‘</button>
                            <button onclick="deleteRoute('${key}')" class="text-xs text-red-600 hover:text-red-800 font-medium">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                // å¼ºåˆ¶å¡ç‰‡ä¸º flex åˆ—å¸ƒå±€ï¼Œä¿æŒæ¯”ä¾‹æ—¶å†…éƒ¨å¯æ­£ç¡®æ”¶ç¼©
                li.style.display = 'flex';
                li.style.flexDirection = 'column';
                li.style.justifyContent = 'space-between';
                li.style.overflow = 'hidden';
                const content = li.querySelector('.p-4');
                if (content) {
                    content.style.overflow = 'hidden';
                    content.style.minHeight = '0';
                    content.style.display = 'flex';
                    content.style.flexDirection = 'column';
                    content.style.justifyContent = 'space-between';
                }
                listEl.appendChild(li);
            });
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = Object.keys(cachedRoutes).length;
            
            // User defined known domains for identification.
            // If the admin provided labeled domain groups and selected an active remark,
            // use that group's domains as the known list; otherwise fall back to defaults.
            let KNOWN_DOMAINS;
            const activeSelect = document.getElementById('activeRemarkSelect');
            if (window.domainConfig && Array.isArray(window.domainConfig.groups)) {
                const labels = Array.isArray(window.domainConfig.groupLabels) ? window.domainConfig.groupLabels : [];
                if (activeSelect && activeSelect.value && labels.length > 0) {
                    const idx = labels.indexOf(activeSelect.value);
                    if (idx !== -1 && Array.isArray(window.domainConfig.groups[idx])) {
                        KNOWN_DOMAINS = window.domainConfig.groups[idx].slice();
                    }
                }
            }

            if (!KNOWN_DOMAINS) {
                KNOWN_DOMAINS = [
                    // RSSHub
                    'rss.injahow.cn', 'hub.slarker.me', 'rsshub.rssforever.com', 
                    'rsshub.howie6879.com', 'rsshub.stefanzhang.com', 'rsshub.pseudoyu.com', 
                    'rsshub.imaegoo.com', 
                    // Twitter
                    'twitter.com', 'x.com',
                    // Common Defaults
                    'rsshub.app', 'rsshub.feed', 'rsshub.io', 'rsshub.ink'
                ];
            }
            
            const domainCounts = {};
            Object.values(cachedRoutes).forEach(config => {
                if (config.url) {
                    try {
                        const hostname = new URL(config.url).hostname;
                        domainCounts[hostname] = (domainCounts[hostname] || 0) + 1;
                    } catch (e) {}
                }
            });
            
            // Find the most active domain that is in our known list
            let topDomain = '';
            let maxCount = 0;
            
            // First pass: Check known domains
            for (const domain of KNOWN_DOMAINS) {
                if (domainCounts[domain] && domainCounts[domain] > maxCount) {
                    maxCount = domainCounts[domain];
                    topDomain = domain;
                }
            }
            
            // Fallback: If no known domain found, just take the absolute top one
            if (!topDomain) {
                for (const [domain, count] of Object.entries(domainCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        topDomain = domain;
                    }
                }
            }
            
            const domainEl = document.getElementById('stat-active-domain');
            const containerEl = document.getElementById('stat-active-domain-container');
            
            if (topDomain && containerEl && domainEl) {
                domainEl.textContent = topDomain;
                containerEl.style.display = 'block';
            } else if (containerEl) {
                containerEl.style.display = 'none';
            }
            
            const allRoutes = Object.entries(cachedRoutes)
                .filter(([_, config]) => config.status && config.status.lastUpdate);

            // --- Recent Updates (Top 10) ---
            const recentContainer = document.getElementById('stat-recent');
            if (recentContainer) {
                const recentRoutes = [...allRoutes]
                    .sort((a, b) => b[1].status.lastUpdate - a[1].status.lastUpdate)
                    .slice(0, 10);
                    
                if (recentRoutes.length === 0) {
                    recentContainer.innerHTML = '<p class="text-sm text-gray-400">æš‚æ— æ›´æ–°è®°å½•</p>';
                } else {
                    recentContainer.innerHTML = recentRoutes.map(([key, config]) => `
                        <div class="flex items-center justify-between text-sm border-b border-gray-100 pb-2 last:border-0 last:pb-0">
                            <div class="flex items-center gap-2 truncate">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                <span class="font-medium text-gray-700 truncate" title="${key}">${key}</span>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">${timeAgo(config.status.lastUpdate)}</span>
                        </div>
                    `).join('');
                }
            }

            // --- Oldest Updates (Top 10) ---
            const oldestContainer = document.getElementById('stat-oldest');
            if (oldestContainer) {
                const oldestRoutes = [...allRoutes]
                    .sort((a, b) => a[1].status.lastUpdate - b[1].status.lastUpdate)
                    .slice(0, 10);
                    
                if (oldestRoutes.length === 0) {
                    oldestContainer.innerHTML = '<p class="text-sm text-gray-400">æš‚æ— æ›´æ–°è®°å½•</p>';
                } else {
                    oldestContainer.innerHTML = oldestRoutes.map(([key, config]) => `
                        <div class="flex items-center justify-between text-sm border-b border-gray-100 pb-2 last:border-0 last:pb-0">
                            <div class="flex items-center gap-2 truncate">
                                <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                                <span class="font-medium text-gray-700 truncate" title="${key}">${key}</span>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">${timeAgo(config.status.lastUpdate)}</span>
                        </div>
                    `).join('');
                }
            }
        }

        function timeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'åˆšåˆš';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'åˆ†é’Ÿå‰';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'å°æ—¶å‰';
            const days = Math.floor(hours / 24);
            return days + 'å¤©å‰';
        }

        window.editRoute = function(key) {
            const config = cachedRoutes[key];
            if (!config) return;
            
            document.getElementById('routeKey').value = key;
            document.getElementById('url').value = config.url || '';
            document.getElementById('type').value = config.type || 'html';
            document.getElementById('itemSelector').value = config.itemSelector || '';
            document.getElementById('titleSelector').value = config.titleSelector || '';
            document.getElementById('linkSelector').value = config.linkSelector || '';
            document.getElementById('linkNeedJoin').checked = config.linkNeedJoin || false;
            document.getElementById('linkBaseUrl').value = config.linkBaseUrl || '';
            document.getElementById('linkBaseUrl').classList.toggle('hidden', !config.linkNeedJoin);
            document.getElementById('descSelector').value = config.descSelector || '';
            document.getElementById('dateSelector').value = config.dateSelector || '';
            document.getElementById('channelTitle').value = config.channelTitle || '';
            document.getElementById('maxItems').value = config.maxItems || 20;
            document.getElementById('encoding').value = config.encoding || 'auto';
            document.getElementById('fullText').checked = config.fullText || false;
            document.getElementById('fullTextSelector').value = config.fullTextSelector || '';
            document.getElementById('timestampMode').checked = config.timestampMode || false;
            document.getElementById('timestampUnit').value = config.timestampUnit || 'ms';
            document.getElementById('timestampMode').checked = config.timestampMode || false;
            document.getElementById('timestampUnit').value = config.timestampUnit || 'ms';
            document.getElementById('reverseOrder').checked = config.reverseOrder || false;
            document.getElementById('usePuppeteer').checked = config.usePuppeteer || false;
            
            // æ˜¾ç¤º/éšè—å…¨æ–‡é…ç½®
            if (config.fullText) {
                document.getElementById('fullTextConfig').classList.remove('hidden');
            } else {
                document.getElementById('fullTextConfig').classList.add('hidden');
            }
            
            // æ˜¾ç¤º/éšè—æ—¶é—´æˆ³é…ç½®
            if (config.timestampMode) {
                document.getElementById('timestampConfig').classList.remove('hidden');
            } else {
                document.getElementById('timestampConfig').classList.add('hidden');
            }
            
            updatePlaceholder(); // æ›´æ–°å ä½ç¬¦
            
            // é‡ç½®ä¸ºé¢„è§ˆæ¨¡å¼å¹¶åŠ è½½é¢„è§ˆ
            document.getElementById('previewTitle').textContent = 'å¯è§†åŒ–é¢„è§ˆ';
            document.getElementById('visualPreview').classList.remove('hidden');
            document.getElementById('testResult').classList.add('hidden');
            loadPreview();
            
            showPage('editor');
        };

        window.deleteRoute = async function(key) {
            if (!confirm('ç¡®å®šåˆ é™¤ ' + key + ' å—?')) return;
            await authFetch(API_BASE + '?key=' + key, { method: 'DELETE' });
            loadRoutes();
        };

        // --- Form & Test ---
        function getFormData() {
            return {
                key: document.getElementById('routeKey').value,
                config: {
                    url: document.getElementById('url').value,
                    type: document.getElementById('type').value,
                    itemSelector: document.getElementById('itemSelector').value,
                    titleSelector: document.getElementById('titleSelector').value,
                    linkSelector: document.getElementById('linkSelector').value,
                    linkNeedJoin: document.getElementById('linkNeedJoin').checked,
                    linkBaseUrl: document.getElementById('linkBaseUrl').value,
                    descSelector: document.getElementById('descSelector').value,
                    dateSelector: document.getElementById('dateSelector').value,
                    channelTitle: document.getElementById('channelTitle').value,
                    maxItems: parseInt(document.getElementById('maxItems').value) || 20,
                    encoding: document.getElementById('encoding').value,
                    fullText: document.getElementById('fullText').checked,
                    fullTextSelector: document.getElementById('fullTextSelector').value,
                    timestampMode: document.getElementById('timestampMode').checked,
                    timestampUnit: document.getElementById('timestampUnit').value,
                    reverseOrder: document.getElementById('reverseOrder').checked,
                    usePuppeteer: document.getElementById('usePuppeteer').checked,
                }
            };
        }

        window.testRule = async function() {
            const data = getFormData();
            
            if (!data.config.url) {
                alert('è¯·å¡«å†™ URL');
                return;
            }
            
            if (!data.config.itemSelector) {
                // RSS ç±»å‹å¦‚æœæ²¡å¡«é€‰æ‹©å™¨ï¼Œåç«¯ä¼šè‡ªåŠ¨å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥æ”¾è¡Œ
                if (data.config.type === 'rss') {
                    // Do nothing, allow empty selector
                } else {
                    alert('è¯·å¡«å†™åˆ—è¡¨é€‰æ‹©å™¨');
                    return;
                }
            }

            // åˆ‡æ¢åˆ°æµ‹è¯•ç»“æœè§†å›¾
            document.getElementById('previewTitle').textContent = 'æµ‹è¯•ç»“æœ';
            document.getElementById('visualPreview').classList.add('hidden');
            document.getElementById('testResult').classList.remove('hidden');

            const testResult = document.getElementById('testResult');
            testResult.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';

            try {
                // Inject key into config for preview so fallbacks work
                const previewConfig = { ...data.config, key: data.key };
                const res = await authFetch(PREVIEW_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(previewConfig)
                });
                
                // Check for JSON response
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    // Try to extract error message from HTML if possible, or just show start of text
                    let errorMsg = 'Server returned non-JSON response';
                    if (text.includes('<title>')) {
                        const match = text.match(/<title>(.*?)<\/title>/);
                        if (match) errorMsg += ': ' + match[1];
                    }
                    throw new Error(errorMsg + ' (Check console for details)');
                }

                const result = await res.json();
                
                if (result.isError) {
                    testResult.innerHTML = `<div class="bg-red-50 p-4 rounded text-red-700 text-sm">${result.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                    return;
                }

                if (!result.items || result.items.length === 0) {
                    testResult.innerHTML = '<div class="text-center text-gray-500 py-10">æœªæ‰¾åˆ°ä»»ä½•æ¡ç›®ï¼Œè¯·æ£€æŸ¥é€‰æ‹©å™¨ã€‚</div>';
                    return;
                }

                const maxItems = data.config.maxItems || 20;
                const actualCount = result.items.length;
                const headerHtml = `
                    <div class="bg-green-50 border border-green-200 rounded-md p-3 mb-4 text-sm">
                        <span class="text-green-800 font-medium">âœ“ æˆåŠŸè·å– <strong>${actualCount}</strong> æ¡æ•°æ®</span>
                        <span class="text-gray-600 ml-2">(é…ç½®: ${maxItems} æ¡)</span>
                    </div>
                `;

                testResult.innerHTML = headerHtml + result.items.map(item => {
                    const desc = item.description || '';
                    const descLength = desc.length;
                    // Strip HTML tags for preview to prevent layout breakage due to unclosed tags in truncated text
                    const plainText = desc.replace(/<[^>]+>/g, '');
                    const descPreview = plainText.length > 300 ? plainText.substring(0, 300) + '...' : plainText;
                    
                    return `
                        <div class="border-l-4 border-blue-500 bg-gray-50 p-3 rounded shadow-sm text-sm mb-3">
                            <h4 class="font-bold text-gray-900 mb-1"><a href="${item.link || '#'}" target="_blank" class="hover:underline text-blue-600">${item.title || 'æ— æ ‡é¢˜'}</a></h4>
                            <div class="text-xs text-gray-500 mb-2">${item.pubDate || 'æ— æ—¥æœŸ'} ${descLength > 0 ? `| å†…å®¹é•¿åº¦: ${descLength} å­—ç¬¦` : ''}</div>
                            <div class="text-gray-700 text-sm prose prose-sm max-w-none" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;">
                                ${descPreview || '<span class="text-gray-400">æ— å†…å®¹</span>'}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Display debug logs at bottom of left panel if available
                if (result.logs && result.logs.length > 0) {
                    const debugSection = document.getElementById('debugLogs');
                    if (debugSection) {
                        debugSection.innerHTML = `
                            <div class="text-xs font-medium text-gray-700 mb-2">ğŸ“‹ è°ƒè¯•æ—¥å¿—:</div>
                            <div class="space-y-1 text-xs font-mono text-gray-600">
                                ${result.logs.map(log => `<div>${log}</div>`).join('')}
                            </div>
                        `;
                        debugSection.classList.remove('hidden');
                    }
                }

            } catch (e) {
                testResult.innerHTML = `<div class="bg-red-50 p-4 rounded text-red-700 text-sm">è¯·æ±‚å¤±è´¥: ${e.message}</div>`;
            }
        };

        document.getElementById('routeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = getFormData();
            
            document.getElementById('globalLoading').classList.remove('hidden');

            try {
                await authFetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                alert('âœ“ ä¿å­˜æˆåŠŸï¼ç¼“å­˜å·²è‡ªåŠ¨æ¸…é™¤ï¼Œç«‹å³ç”Ÿæ•ˆã€‚');
                loadRoutes(); // Refresh cache
                showPage('list'); // è·³è½¬åˆ°åˆ—è¡¨é¡µé¢
                // éšè—è°ƒè¯•æ—¥å¿—
                const debugSection = document.getElementById('debugLogs');
                if (debugSection) {
                    debugSection.classList.add('hidden');
                    debugSection.innerHTML = '';
                }
            } catch(e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            } finally {
                document.getElementById('globalLoading').classList.add('hidden');
            }
        });

        // --- Visual Selector ---
        let currentVisualMode = 'item';
        let currentPreviewMode = 'item';

        // é¢„è§ˆæ¨¡å¼åˆ‡æ¢å‡½æ•°
        window.setPreviewMode = function(mode) {
            currentPreviewMode = mode;
            const type = document.getElementById('type').value;
            
            // Update UI buttons
            document.querySelectorAll('#visualPreview .tool-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-300');
                btn.classList.add('bg-white', 'text-gray-700');
            });
            
            const btn = document.getElementById('preview-btn-' + mode);
            if (btn) {
                btn.classList.remove('bg-white', 'text-gray-700');
                btn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
            }

            // å‘é€æ¨¡å¼åˆ° iframeï¼ˆä»…åœ¨ HTML æ¨¡å¼ä¸‹ï¼‰
            if (type !== 'json') {
                const frame = document.getElementById('previewFrame');
                if (frame.contentWindow && frame.src) {
                    const itemSelector = document.getElementById('itemSelector').value;
                    frame.contentWindow.postMessage({ 
                        type: 'setMode', 
                        mode: mode,
                        selectorType: type,
                        itemSelector: itemSelector
                    }, '*');
                }
            }
        };

        // å°†é€‰æ‹©å™¨è„šæœ¬æ³¨å…¥åˆ° preview iframe ä¸­ï¼ˆåœ¨ iframe å¯è®¿é—®æ—¶ï¼‰
        function injectSelectorScriptToFrame(frame) {
            try {
                const doc = frame.contentDocument || (frame.contentWindow && frame.contentWindow.document);
                if (!doc) return;
                // å¦‚æœå·²ç»æ³¨å…¥åˆ™è·³è¿‡
                if (doc.getElementById('injected-selector-script')) return;

                const script = doc.createElement('script');
                script.id = 'injected-selector-script';
                // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°å­—ç¬¦ä¸²åŒ–æ³¨å…¥ï¼Œé¿å…è½¬ä¹‰é—®é¢˜
                script.textContent = '(' + function() {
                    if (window.__selectorInjected) return;
                    window.__selectorInjected = true;

                    let currentMode = 'item';

                    // æ ·å¼
                    try {
                        const style = document.createElement('style');
                        style.id = 'selector-style';
                        style.textContent = '\n.sel-overlay { position: absolute; background: rgba(0,128,255,0.08); border: 2px dashed rgba(0,128,255,0.7); z-index: 2147483647; pointer-events: none; }\n.sel-highlight-temp { outline: 2px solid rgba(255,0,0,0.6); background: rgba(255,0,0,0.04); }\n';
                        document.head.appendChild(style);
                    } catch (e) { /* ignore */ }

                    // åˆ›å»º overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'sel-overlay';
                    overlay.style.display = 'none';
                    overlay.id = 'sel-overlay';
                    document.body.appendChild(overlay);

                    let hovered = null;

                    function cssEscape(s) {
                        if (window.CSS && CSS.escape) return CSS.escape(s);
                        return s.replace(/(["'\\!#$%&'()*+,./:;<=>?@\[\]^`{|}~ ])/g, function(m){ return '\\' + m; });
                    }

                    function uniqueSelector(el) {
                        if (!el || el.nodeType !== 1) return '';
                        if (el.id) return '#' + cssEscape(el.id);
                        const parts = [];
                        let node = el;
                        const doc = document;
                        while (node && node.nodeType === 1 && node !== doc.documentElement) {
                            let part = node.tagName.toLowerCase();
                            if (node.classList && node.classList.length) {
                                // ä»…ä½¿ç”¨å‰ä¸¤ä¸ªç±»ä»¥é¿å…è¿‡é•¿
                                const classes = Array.from(node.classList).slice(0,2).map(c => '.' + cssEscape(c)).join('');
                                part += classes;
                            }
                            const parent = node.parentNode;
                            if (parent) {
                                const siblings = Array.from(parent.children);
                                const idx = siblings.indexOf(node) + 1;
                                part += `:nth-child(${idx})`;
                            }
                            parts.unshift(part);
                            const sel = parts.join(' > ');
                            try {
                                if (doc.querySelectorAll(sel).length === 1) return sel;
                            } catch (e) {}
                            node = node.parentNode;
                        }
                        return parts.join(' > ');
                    }

                    function onMove(e) {
                        const el = document.elementFromPoint(e.clientX, e.clientY);
                        if (!el || el === overlay) return;
                        hovered = el;
                        const r = el.getBoundingClientRect();
                        overlay.style.display = 'block';
                        overlay.style.left = (r.left + window.scrollX) + 'px';
                        overlay.style.top = (r.top + window.scrollY) + 'px';
                        overlay.style.width = r.width + 'px';
                        overlay.style.height = r.height + 'px';
                    }

                    function onClick(e) {
                        try {
                            e.preventDefault();
                            e.stopPropagation();
                        } catch (e) {}
                        if (!hovered) return;
                        
                        let targetElement = hovered;
                        
                        // æ™ºèƒ½é“¾æ¥é€‰æ‹©ï¼šå¦‚æœå½“å‰æ¨¡å¼æ˜¯linkï¼Œä¸”ç‚¹å‡»çš„ä¸æ˜¯aæ ‡ç­¾ï¼Œå°è¯•æ‰¾åˆ°æœ€è¿‘çš„aæ ‡ç­¾ç¥–å…ˆ
                        if (currentMode === 'link' && hovered.tagName.toLowerCase() !== 'a') {
                            let parent = hovered.parentElement;
                            while (parent && parent.tagName.toLowerCase() !== 'a') {
                                parent = parent.parentElement;
                            }
                            if (parent && parent.tagName.toLowerCase() === 'a') {
                                targetElement = parent;
                            }
                        }
                        
                        // ä¿å­˜æœ€åé€‰ä¸­çš„å…ƒç´ å¼•ç”¨ï¼Œä¾¿äºåç»­ä¸Šä¸‹ç§»åŠ¨
                        window.__lastSelected = targetElement;
                        const sel = uniqueSelector(targetElement) || (() => {
                            try { return targetElement.tagName.toLowerCase(); } catch (e) { return '' }
                        })();
                        // ç¡®ä¿ overlay å®šä½åˆ°å½“å‰å…ƒç´ 
                        try {
                            const r = targetElement.getBoundingClientRect();
                            overlay.style.display = 'block';
                            overlay.style.left = (r.left + window.scrollX) + 'px';
                            overlay.style.top = (r.top + window.scrollY) + 'px';
                            overlay.style.width = r.width + 'px';
                            overlay.style.height = r.height + 'px';
                        } catch (e) {}
                        parent.postMessage({ type: 'selected', mode: currentMode, selector: sel }, '*');
                    }

                    document.addEventListener('mousemove', onMove, true);
                    document.addEventListener('click', onClick, true);

                    // æ¥æ”¶çˆ¶é¡µé¢å‘½ä»¤ï¼šåˆ‡æ¢æ¨¡å¼ã€é¢„è§ˆåº”ç”¨/æ¸…é™¤
                    window.addEventListener('message', function(ev) {
                        if (!ev.data) return;
                        if (ev.data.type === 'setMode') {
                            currentMode = ev.data.mode || 'item';
                        } else if (ev.data.type === 'countSelectors' && Array.isArray(ev.data.candidates)) {
                            // è®¡ç®—æ¯ä¸ªå€™é€‰é€‰æ‹©å™¨çš„åŒ¹é…æ•°é‡å¹¶å›ä¼ 
                            const counts = {};
                            try {
                                ev.data.candidates.forEach(s => {
                                    try { counts[s] = document.querySelectorAll(s).length; } catch (err) { counts[s] = -1; }
                                });
                            } catch (e) {}
                            parent.postMessage({ type: 'selectorCounts', counts: counts }, '*');
                        } else if (ev.data.type === 'previewApply' && ev.data.selector) {
                            try {
                                const nodes = document.querySelectorAll(ev.data.selector);
                                if (nodes && nodes.length > 0) {
                                    if (!document.getElementById('blocked-preview-style')) {
                                        const s = document.createElement('style');
                                        s.id = 'blocked-preview-style';
                                        s.textContent = '.blocked-preview{display:none !important;}';
                                        document.head.appendChild(s);
                                    }
                                    nodes.forEach(n => n.classList.add('blocked-preview'));
                                }
                            } catch (e) {}
                        } else if (ev.data.type === 'previewClear') {
                            try { document.querySelectorAll('.blocked-preview').forEach(n => n.classList.remove('blocked-preview')); } catch(e){}
                        } else if (ev.data.type === 'clearSelector') {
                            overlay.style.display = 'none';
                        } else if (ev.data.type === 'setDepth') {
                            // åŸºäºæœ€åé€‰ä¸­çš„å…ƒç´ å‘ä¸Š/å‘ä¸‹ç§»åŠ¨æ·±åº¦
                            const depth = parseInt(ev.data.depth) || 0;
                            let el = window.__lastSelected || null;
                            if (!el) {
                                // å°è¯•æ ¹æ® overlay ä¸­å¿ƒç‚¹å¯»æ‰¾å…ƒç´ 
                                try {
                                    const cx = overlay.getBoundingClientRect().left + overlay.getBoundingClientRect().width/2;
                                    const cy = overlay.getBoundingClientRect().top + overlay.getBoundingClientRect().height/2;
                                    el = document.elementFromPoint(cx - window.scrollX, cy - window.scrollY);
                                } catch (e) { el = null; }
                            }
                            if (el) {
                                let target = el;
                                for (let i = 0; i < depth; i++) {
                                    if (target.parentElement) target = target.parentElement; else break;
                                }
                                try {
                                    const sel = uniqueSelector(target);
                                    const count = (document.querySelectorAll(sel) || []).length;
                                    const r = target.getBoundingClientRect();
                                    overlay.style.display = 'block';
                                    overlay.style.left = (r.left + window.scrollX) + 'px';
                                    overlay.style.top = (r.top + window.scrollY) + 'px';
                                    overlay.style.width = r.width + 'px';
                                    overlay.style.height = r.height + 'px';
                                    parent.postMessage({ type: 'navigated', selector: sel, count: count }, '*');
                                } catch (e) {}
                            }
                        } else if (ev.data.type === 'navigate') {
                            const dir = ev.data.direction;
                            let el = window.__lastSelected || null;
                            if (!el) return;
                            let target = el;
                            if (dir === 'up') {
                                if (target.parentElement) target = target.parentElement;
                            } else if (dir === 'down') {
                                if (target.children && target.children.length > 0) target = target.children[0];
                            }
                            if (target) {
                                window.__lastSelected = target;
                                try {
                                    const sel = uniqueSelector(target);
                                    const count = (document.querySelectorAll(sel) || []).length;
                                    const r = target.getBoundingClientRect();
                                    overlay.style.display = 'block';
                                    overlay.style.left = (r.left + window.scrollX) + 'px';
                                    overlay.style.top = (r.top + window.scrollY) + 'px';
                                    overlay.style.width = r.width + 'px';
                                    overlay.style.height = r.height + 'px';
                                    parent.postMessage({ type: 'navigated', selector: sel, count: count }, '*');
                                } catch (e) {}
                            }
                        }
                    }, false);

                }.toString() + ')();';

                doc.body.appendChild(script);
            } catch (e) {
                // æ³¨å…¥å¤±è´¥ï¼ˆå¯èƒ½è·¨åŸŸæˆ–æ–‡æ¡£æœªå‡†å¤‡å¥½ï¼‰
            }
        }
        // Collapsible Panel Logic
        window.toggleConfigPanel = function() {
            const content = document.getElementById('configPanelContent');
            const icon = document.getElementById('configPanelIcon');
            const panel = document.getElementById('configPanel');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(0deg)';
                panel.classList.remove('border-b-0'); // Add border back if needed
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(-90deg)';
                panel.classList.add('border-b-0'); // Remove potential double border
            }
        };
        function xmlToJson(xml) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xml, "text/xml");
            
            function elementToObj(element) {
                const obj = {};
                // Attributes
                if (element.attributes && element.attributes.length > 0) {
                    for (let i = 0; i < element.attributes.length; i++) {
                        const attr = element.attributes[i];
                        obj['@' + attr.name] = attr.value;
                    }
                }
                
                // Children
                if (element.children.length === 0) {
                    const text = element.textContent.trim();
                    if (Object.keys(obj).length === 0) return text;
                    if (text) obj['#text'] = text;
                    return obj;
                }
                
                for (let i = 0; i < element.children.length; i++) {
                    const child = element.children[i];
                    const childName = child.tagName;
                    const childObj = elementToObj(child);
                    
                    if (obj[childName]) {
                        if (!Array.isArray(obj[childName])) {
                            obj[childName] = [obj[childName]];
                        }
                        obj[childName].push(childObj);
                    } else {
                        obj[childName] = childObj;
                    }
                }
                return obj;
            }
            
            const root = doc.documentElement;
            const result = {};
            if (root) {
                result[root.tagName] = elementToObj(root);
            }
            return result;
        }

        // Sniffer Logic
        window.toggleSniffer = function() {
            isSniffing = !isSniffing;
            const btn = document.getElementById('btn-sniffer');
            const panel = document.getElementById('snifferResults');
            
            if (isSniffing) {
                btn.classList.remove('bg-indigo-50', 'text-indigo-700', 'border-indigo-200');
                btn.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
                btn.innerHTML = 'ğŸ›‘ åœæ­¢å—…æ¢';
                panel.classList.remove('hidden');
                panel.innerHTML = '<div class="text-gray-400 text-center py-2 text-xs">ğŸ‘€ ç›‘å¬ä¸­... è¯·åœ¨é¢„è§ˆé¡µé¢ä¸­æ“ä½œä»¥è§¦å‘è¯·æ±‚</div>';
                
                // Reload with JS enabled
                const url = document.getElementById('url').value;
                if (!url) return alert('è¯·å…ˆè¾“å…¥æº URL');
                
                const previewFrame = document.getElementById('previewFrame');
                const enc = document.getElementById('encoding').value || 'auto';
                const encVal = encodeURIComponent(enc);
                // Force reload via src to enable JS and injection
                previewFrame.src = PROXY_API + '?url=' + encodeURIComponent(url) + '&encoding=' + encVal + '&enable_js=true';
            } else {
                btn.classList.add('bg-indigo-50', 'text-indigo-700', 'border-indigo-200');
                btn.classList.remove('bg-red-100', 'text-red-700', 'border-red-300');
                btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"></path></svg> ç½‘ç»œå—…æ¢';
                panel.classList.add('hidden');
                // Reload normal static preview
                loadPreview();
            }
        };

        window.useSniffedUrl = function(url) {
            document.getElementById('url').value = url;
            document.getElementById('type').value = 'json';
            updatePlaceholder();
            // Turn off sniffer
            if (isSniffing) toggleSniffer();
            // Load JSON preview logic handled by toggleSniffer calling loadPreview
        };

        // åŠ è½½é¢„è§ˆé¡µé¢
        window.loadPreview = async function() {
            const url = document.getElementById('url').value;
            const type = document.getElementById('type').value;
            
            // ç¡®ä¿åˆ‡æ¢å›é¢„è§ˆæ¨¡å¼
            document.getElementById('previewTitle').textContent = 'å¯è§†åŒ–é¢„è§ˆ';
            document.getElementById('visualPreview').classList.remove('hidden');
            document.getElementById('testResult').classList.add('hidden');

            if (!url) {
                document.getElementById('previewFrame').src = '';
                document.getElementById('jsonPreview').innerHTML = '';
                return;
            }

            if (type === 'json' || type === 'rss') {
                // JSON/RSS Preview
                document.getElementById('previewFrame').classList.add('hidden');
                document.getElementById('previewToolbar').classList.remove('hidden'); // Show toolbar
                document.getElementById('jsonPreview').classList.remove('hidden');
                document.getElementById('jsonPreview').innerHTML = '<div class="text-center text-gray-400 py-10">åŠ è½½ä¸­...</div>';
                
                // Update toolbar labels
                document.getElementById('preview-btn-item').textContent = 'ğŸ“¦ åˆ—è¡¨æ•°ç»„';
                document.getElementById('preview-btn-title').textContent = 'ğŸ“ æ ‡é¢˜å­—æ®µ';
                document.getElementById('preview-btn-link').textContent = 'ğŸ”— é“¾æ¥å­—æ®µ';
                document.getElementById('preview-btn-desc').textContent = 'ğŸ“„ æè¿°å­—æ®µ';
                document.getElementById('preview-btn-date').textContent = 'ğŸ“… æ—¥æœŸå­—æ®µ';

                try {
                    // Use proxy to get raw content
                    // Prefer saved route encoding when editing an existing route
                    const routeKey = document.getElementById('routeKey').value;
                    let enc = document.getElementById('encoding').value || 'auto';
                    if (routeKey && cachedRoutes[routeKey] && cachedRoutes[routeKey].encoding) enc = cachedRoutes[routeKey].encoding;
                    const encVal = encodeURIComponent(enc);
                    const response = await authFetch(PROXY_JSON_API + '?url=' + encodeURIComponent(url) + '&encoding=' + encVal);
                    let data;
                    if (type === 'rss') {
                        const text = await response.text();
                        data = xmlToJson(text);
                    } else {
                        data = await response.json();
                    }
                    renderJsonTree(data, '', 0, document.getElementById('jsonPreview'));
                } catch (e) {
                    document.getElementById('jsonPreview').innerHTML = '<div class="text-center text-red-400 py-10">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
                }
                return;
              }
            
            // HTML Preview
            document.getElementById('previewFrame').classList.remove('hidden');
            document.getElementById('previewToolbar').classList.remove('hidden');
            document.getElementById('jsonPreview').classList.add('hidden');

            // Reset toolbar labels for HTML
            document.getElementById('preview-btn-item').textContent = 'æ¡ç›®';
            document.getElementById('preview-btn-title').textContent = 'æ ‡é¢˜';
            document.getElementById('preview-btn-link').textContent = 'é“¾æ¥';
            document.getElementById('preview-btn-desc').textContent = 'æè¿°';
            document.getElementById('preview-btn-date').textContent = 'æ—¥æœŸ';
            
            const previewFrame = document.getElementById('previewFrame');
            const jsonPreview = document.getElementById('jsonPreview');
            // Use fetch to detect proxy errors (Cloudflare 1002 etc.) and show friendly message
            (async () => {
                try {
                    // Prefer saved route encoding when editing an existing route
                    const routeKey = document.getElementById('routeKey').value;
                    let enc = document.getElementById('encoding').value || 'auto';
                    if (routeKey && cachedRoutes[routeKey] && cachedRoutes[routeKey].encoding) enc = cachedRoutes[routeKey].encoding;
                    const encVal = encodeURIComponent(enc);
                    const res = await authFetch(PROXY_API + '?url=' + encodeURIComponent(url) + '&encoding=' + encVal);
                    const ct = res.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                        const data = await res.json();
                        // If proxy returned structured error, show friendly message instead of raw error page
                        if (data && data.error) {
                            previewFrame.classList.add('hidden');
                            jsonPreview.classList.remove('hidden');
                            jsonPreview.innerHTML = `<div class="text-center p-6 text-sm text-red-600">é¢„è§ˆå¤±è´¥: ${escapeHtml(data.message || data.error)}</div>`;
                            return;
                        }
                    }

                    // Otherwise treat as HTML/text and render inside iframe using srcdoc
                    const text = await res.text();
                    previewFrame.classList.remove('hidden');
                    jsonPreview.classList.add('hidden');
                    try {
                        previewFrame.srcdoc = text;
                        // ç«‹å³å°è¯•æ³¨å…¥é€‰æ‹©å™¨è„šæœ¬ï¼ˆsrcdoc å¯ç›´æ¥è®¿é—®ï¼‰
                        injectSelectorScriptToFrame(previewFrame);
                    } catch (e) {
                        // Fallback: create blob URL
                        const blob = new Blob([text], { type: 'text/html' });
                        const blobUrl = URL.createObjectURL(blob);
                        previewFrame.src = blobUrl;
                    }

                    // åœ¨ iframe åŠ è½½å®Œæˆæ—¶å†æ¬¡å°è¯•æ³¨å…¥å¹¶è®¾ç½®æ¨¡å¼
                    previewFrame.onload = function() {
                        try { injectSelectorScriptToFrame(previewFrame); } catch (e) {}
                        try { setPreviewMode(currentPreviewMode); } catch (e) {}
                    };
                    // å…¼å®¹æƒ…å†µï¼Œå»¶è¿Ÿè®¾ç½®ä¸€æ¬¡æ¨¡å¼
                    setTimeout(() => setPreviewMode(currentPreviewMode), 500);
                } catch (e) {
                    previewFrame.classList.add('hidden');
                    jsonPreview.classList.remove('hidden');
                    jsonPreview.innerHTML = `<div class="text-center p-6 text-sm text-red-600">è¯·æ±‚é¢„è§ˆå¤±è´¥: ${escapeHtml(e.message || String(e))}</div>`;
                }
            })();
        };

        window.updatePlaceholder = function() {
            const type = document.getElementById('type').value;
            const itemInput = document.getElementById('itemSelector');
            const titleInput = document.getElementById('titleSelector');
            const linkInput = document.getElementById('linkSelector');
            const descInput = document.getElementById('descSelector');
            const dateInput = document.getElementById('dateSelector');
            
            const selectorSection = document.getElementById('section-selectors');
            if (false) {
                // placeholder - telegram support removed
            } else {
                selectorSection.style.display = 'block';
                
                // RSS ç±»å‹ä¸éœ€è¦å¼ºåˆ¶å¿…å¡«åˆ—è¡¨é€‰æ‹©å™¨
                if (type === 'rss') {
                    itemInput.removeAttribute('required');
                } else {
                    itemInput.setAttribute('required', 'required');
                }
                
                if (type === 'xpath') {
                    itemInput.placeholder = '//div[@class="list-item"]';
                    titleInput.placeholder = './/h2/a';
                    linkInput.placeholder = './/a/@href';
                    descInput.placeholder = './/div[@class="desc"]';
                    dateInput.placeholder = './/span[@class="date"]';
                } else if (type === 'json' || type === 'rss') {
                    itemInput.placeholder = 'data.items (å¦‚æœæ•´ä¸ªå“åº”æ˜¯æ•°ç»„å¯ç•™ç©º)';
                    titleInput.placeholder = 'title æˆ– æ¨¡æ¿:ç»¼åˆåˆ†ä½:{indexValue}';
                    linkInput.placeholder = 'url æˆ– æ¨¡æ¿:https://site.com/{id}';
                    descInput.placeholder = 'content æˆ– æ¨¡æ¿:è¯¦æƒ…:{description}';
                    dateInput.placeholder = 'publishTime (æˆ– created_at)';
                } else {
                    itemInput.placeholder = '.post-item';
                    titleInput.placeholder = 'h2 a';
                    linkInput.placeholder = 'a';
                    descInput.placeholder = '.summary';
                    dateInput.placeholder = '.date';
                }
            }
        };

        window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'selected') {
                const { mode, selector } = e.data;

                if (mode === 'item') {
                    document.getElementById('itemSelector').value = selector;
                } else if (mode === 'title') {
                    document.getElementById('titleSelector').value = selector;
                } else if (mode === 'link') {
                    // æ™ºèƒ½å¤„ç†é“¾æ¥ï¼šå¦‚æœé€‰æ‹©å™¨å·²ç»æ˜¯ a æ ‡ç­¾ï¼Œåˆ™ä½¿ç”¨ @href è·å–é“¾æ¥
                    let linkSelector = selector;
                    if (selector.toLowerCase().includes('a') && !selector.includes('@href')) {
                        // å¦‚æœé€‰æ‹©å™¨åŒ…å« a æ ‡ç­¾ï¼Œå°è¯•æ·»åŠ  @href æ¥è·å–é“¾æ¥å±æ€§
                        linkSelector = selector + '/@href';
                    }
                    document.getElementById('linkSelector').value = linkSelector;
                } else if (mode === 'desc') {
                    document.getElementById('descSelector').value = selector;
                } else if (mode === 'date') {
                    document.getElementById('dateSelector').value = selector;
                }

                try { showSelectorCandidates(mode, selector); } catch (err) { console.warn(err); }

                // ADGUARD STYLE: Update Refinement Toolbar
                const toolbar = document.getElementById('selectionRefineToolbar');
                if (toolbar) {
                    toolbar.classList.remove('hidden');
                    const depth = e.data.depth || 0;
                    document.getElementById('depthSlider').value = depth;
                    document.getElementById('depthLabel').textContent = 'å±‚çº§: ' + depth;
                }
            } else if (e.data && e.data.type === 'selectorCounts') {
                try { renderCandidateCounts(e.data.counts || {}); } catch (err) { console.warn(err); }
            } else if (e.data && e.data.type === 'ajax-sniff') {
                if (!isSniffing) return;
                const { url, method, type } = e.data.payload;
                // Simple filter
                if (!url.startsWith('http')) return;
                
                const panel = document.getElementById('snifferResults');
                // Remove placeholder
                if (panel.textContent.includes('ç›‘å¬ä¸­')) panel.innerHTML = '';
                
                // Check dupes
                const exists = Array.from(panel.children).some(el => el.dataset.url === url);
                if (exists) return;
                
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-1.5 bg-white border border-gray-200 rounded hover:bg-blue-50 cursor-pointer break-all transition-colors';
                div.dataset.url = url;
                div.onclick = () => useSniffedUrl(url);
                div.innerHTML = `
                    <span class="text-[10px] font-mono px-1 rounded ${method==='GET'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${method}</span>
                    <span class="text-[10px] font-mono px-1 rounded bg-gray-100 text-gray-600">${type}</span>
                    <span class="flex-1 truncate text-xs text-gray-700" title="${url}">${url}</span>
                    <button class="text-blue-600 hover:text-blue-800 text-[10px] whitespace-nowrap px-2 py-0.5 border border-blue-200 bg-white rounded hover:bg-blue-50">ä½¿ç”¨</button>
                `;
                panel.insertBefore(div, panel.firstChild);
            }
        });

        // ç”Ÿæˆå€™é€‰é€‰æ‹©å™¨ï¼ˆç®€å•ç­–ç•¥ï¼‰
        function generateCandidatesFrom(selector) {
            if (!selector) return [];
            const candidates = [];
            candidates.push(selector);
            candidates.push(selector.replace(/:nth-child\(\d+\)/g, ''));
            const m = selector.match(/([a-z0-9_-]+)\.[a-z0-9_-]+/i);
            if (m) candidates.push(m[0]);
            const parts = selector.split('>').map(s => s.trim()).filter(Boolean);
            if (parts.length > 1) {
                const last = parts[parts.length - 1];
                const parent = parts[parts.length - 2];
                candidates.push(parent + ' > ' + last.replace(/:nth-child\(\d+\)/g, ''));
            }
            const clsMatch = selector.match(/\.[a-z0-9_-]+/ig);
            if (clsMatch && clsMatch.length > 0) {
                candidates.push(clsMatch.slice(0,2).join(''));
            }
            return Array.from(new Set(candidates)).slice(0, 10);
        }

        // åœ¨ preview å·¥å…·æ æ˜¾ç¤ºå€™é€‰é€‰æ‹©å™¨åˆ—è¡¨
        function showSelectorCandidates(mode, selector) {
            const toolbar = document.getElementById('previewToolbar');
            if (!toolbar) return;
            let panel = document.getElementById('selectorCandidates');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'selectorCandidates';
                panel.style.padding = '6px';
                panel.style.borderTop = '1px solid #eee';
                panel.style.display = 'flex';
                panel.style.flexDirection = 'column';
                panel.style.gap = '6px';
                toolbar.appendChild(panel);
            }
            panel.innerHTML = '<div class="text-xs text-gray-600">å€™é€‰é€‰æ‹©å™¨ï¼ˆç‚¹å‡»â€œé¢„è§ˆâ€æŸ¥çœ‹æ•ˆæœï¼Œæˆ–â€œä½¿ç”¨â€å¡«å…¥è¡¨å•ï¼‰</div>';
            const candidates = generateCandidatesFrom(selector);
            candidates.forEach(c => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2';
                row.innerHTML = `
                    <div class="text-xs text-gray-800 truncate" style="flex:1" title="${escapeHtml(c)}">${escapeHtml(c)}</div>
                    <div class="flex gap-1">
                        <button class="btn-cand-preview text-xs px-2 py-1">é¢„è§ˆ</button>
                        <button class="btn-cand-use text-xs px-2 py-1">ä½¿ç”¨</button>
                    </div>
                `;
                const previewBtn = row.querySelector('.btn-cand-preview');
                const useBtn = row.querySelector('.btn-cand-use');
                previewBtn.onclick = () => applyPreviewSelector(c);
                useBtn.onclick = () => {
                    if (mode === 'item') document.getElementById('itemSelector').value = c;
                    else if (mode === 'title') document.getElementById('titleSelector').value = c;
                    else if (mode === 'link') document.getElementById('linkSelector').value = c;
                    else if (mode === 'desc') document.getElementById('descSelector').value = c;
                    else if (mode === 'date') document.getElementById('dateSelector').value = c;
                };
                panel.appendChild(row);
            });

            try {
                const frame = document.getElementById('previewFrame');
                if (frame && frame.contentWindow) {
                    frame.contentWindow.postMessage({ type: 'countSelectors', candidates: candidates }, '*');
                }
            } catch (e) { console.warn(e); }
        }

        // æ¸²æŸ“æ¥è‡ª iframe çš„è®¡æ•°ç»“æœ
        function renderCandidateCounts(counts) {
            const panel = document.getElementById('selectorCandidates');
            if (!panel) return;
            const rows = panel.querySelectorAll('div.flex.items-center');
            rows.forEach(row => {
                const textDiv = row.querySelector('div');
                const selector = textDiv && textDiv.title;
                if (!selector) return;
                const count = counts[selector] != null ? counts[selector] : counts[decodeURIComponent(selector)];
                let badge = row.querySelector('.cand-count');
                if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'cand-count text-xs text-gray-500';
                    badge.style.minWidth = '48px';
                    badge.style.textAlign = 'right';
                    row.insertBefore(badge, row.querySelector('.flex'));
                }
                badge.textContent = (typeof count === 'number' && count >= 0) ? (count + ' ä¸ª') : 'æœªçŸ¥';
            });
        }

        function applyPreviewSelector(selector) {
            const frame = document.getElementById('previewFrame');
            if (!frame || !frame.contentWindow) return;
            frame.contentWindow.postMessage({ type: 'previewClear' }, '*');
            frame.contentWindow.postMessage({ type: 'previewApply', selector: selector }, '*');
        }

        // --- Selection Refinement (AdGuard Style) ---
        window.adjustSelectionDepth = function(delta) {
            const slider = document.getElementById('depthSlider');
            let val = parseInt(slider.value) + delta;
            if (val < parseInt(slider.min)) val = parseInt(slider.min);
            if (val > parseInt(slider.max)) val = parseInt(slider.max);
            slider.value = val;
            onDepthChange(val);
        };

        window.onDepthChange = function(val) {
            document.getElementById('depthLabel').textContent = 'å±‚çº§: ' + val;
            const frame = document.getElementById('previewFrame');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({ type: 'setDepth', depth: parseInt(val) }, '*');
            }
        };

        // ===== JSON é€‰æ‹©å™¨åŠŸèƒ½ =====
        
        function renderJsonTree(data, path = '', level = 0, container = null) {
            const viewer = container || document.getElementById('jsonPreview');
            if (level === 0) viewer.innerHTML = '';
            
            const indent = '  '.repeat(level);
            const isArray = Array.isArray(data);
            const isObject = typeof data === 'object' && data !== null && !isArray;
            
            if (isArray) {
                const arrayPath = path || ''; // Root array path is empty string or just use what is passed
                
                const el = document.createElement('div');
                el.className = 'cursor-pointer hover:bg-gray-800 px-1';
                el.title = 'ç‚¹å‡»é€‰æ‹©æ­¤æ•°ç»„: ' + (arrayPath || 'root');
                el.innerHTML = indent + '<span class="text-gray-500">[</span> <span class="text-yellow-400 text-xs">(æ•°ç»„ï¼Œå…±' + data.length + 'é¡¹)</span>';
                
                // æ•°ç»„å¼€å§‹æ‹¬å·å¯ç‚¹å‡»
                el.onclick = function(e) {
                    e.stopPropagation();
                    if (currentPreviewMode === 'item') {
                        selectJsonPath(arrayPath);
                    }
                };
                
                viewer.appendChild(el);
                
                // åªæ˜¾ç¤ºå‰3ä¸ªå…ƒç´ 
                const itemsToShow = Math.min(3, data.length);
                for (let i = 0; i < itemsToShow; i++) {
                    renderJsonTree(data[i], path + '[' + i + ']', level + 1, viewer);
                }
                
                if (data.length > 3) {
                    const moreEl = document.createElement('div');
                    moreEl.className = 'text-gray-500';
                    moreEl.innerHTML = indent + '  <span class="italic">... è¿˜æœ‰ ' + (data.length - 3) + ' é¡¹</span>';
                    viewer.appendChild(moreEl);
                }
                
                const closeEl = document.createElement('div');
                closeEl.className = 'cursor-pointer hover:bg-gray-800 px-1';
                closeEl.title = 'ç‚¹å‡»é€‰æ‹©æ­¤æ•°ç»„: ' + (arrayPath || 'root');
                closeEl.innerHTML = indent + '<span class="text-gray-500">]</span>';
                
                // é—­åˆæ‹¬å·ä¹Ÿå¯ç‚¹å‡»
                closeEl.onclick = function(e) {
                    e.stopPropagation();
                    if (currentPreviewMode === 'item') {
                        selectJsonPath(arrayPath);
                    }
                };
                
                viewer.appendChild(closeEl);
            } else if (isObject) {
                const el = document.createElement('div');
                el.innerHTML = indent + '<span class="text-gray-500">{</span>';
                viewer.appendChild(el);
                
                for (const key in data) {
                    const value = data[key];
                    const currentPath = path ? path + '.' + key : key;
                    const valueType = Array.isArray(value) ? 'array' : typeof value;
                    
                    if (valueType === 'object' || valueType === 'array') {
                        const keyEl = document.createElement('div');
                        
                        // å¦‚æœæ˜¯æ•°ç»„ï¼Œè®©keyä¹Ÿå¯ä»¥ç‚¹å‡»
                        if (valueType === 'array') {
                            keyEl.className = 'cursor-pointer hover:bg-gray-800 px-1';
                            keyEl.title = 'ç‚¹å‡»é€‰æ‹©æ­¤æ•°ç»„: ' + currentPath;
                            keyEl.innerHTML = indent + '  <span class="text-blue-400">"' + key + '"</span>: <span class="text-yellow-400 text-xs">[æ•°ç»„]</span>';
                            keyEl.onclick = function(e) {
                                e.stopPropagation();
                                if (currentPreviewMode === 'item') {
                                    selectJsonPath(currentPath);
                                }
                            };
                        } else {
                            keyEl.innerHTML = indent + '  <span class="text-blue-400">"' + key + '"</span>: ';
                        }
                        
                        viewer.appendChild(keyEl);
                        renderJsonTree(value, currentPath, level + 1, viewer);
                    } else {
                        const lineEl = document.createElement('div');
                        lineEl.className = 'cursor-pointer hover:bg-gray-800 px-1';
                        lineEl.title = 'ç‚¹å‡»é€‰æ‹©: ' + currentPath;
                        
                        let displayValue = JSON.stringify(value);
                        if (displayValue.length > 50) displayValue = displayValue.substring(0, 50) + '...';
                        
                        let color = 'text-green-400';
                        if (valueType === 'number') color = 'text-yellow-400';
                        else if (valueType === 'boolean') color = 'text-purple-400';
                        else if (value === null) color = 'text-gray-500';
                        
                        lineEl.innerHTML = indent + '  <span class="text-blue-400">"' + key + '"</span>: <span class="' + color + '">' + displayValue + '</span>,';
                        
                        lineEl.onclick = function(e) {
                            e.stopPropagation();
                            if (currentPreviewMode !== 'item') {
                                selectJsonPath(key);
                            }
                        };
                        
                        viewer.appendChild(lineEl);
                    }
                }
                
                const closeEl = document.createElement('div');
                closeEl.innerHTML = indent + '<span class="text-gray-500">}</span>';
                viewer.appendChild(closeEl);
            } else {
                // åŸºæœ¬ç±»å‹
                const el = document.createElement('div');
                el.innerHTML = indent + '<span class="text-green-400">' + JSON.stringify(data) + '</span>';
                viewer.appendChild(el);
            }
        }

        function selectJsonPath(path) {
            // è·å–å½“å‰æ¨¡å¼å¯¹åº”çš„è¾“å…¥æ¡†ID
            let inputId = '';
            if (currentPreviewMode === 'item') inputId = 'itemSelector';
            else if (currentPreviewMode === 'title') inputId = 'titleSelector';
            else if (currentPreviewMode === 'link') inputId = 'linkSelector';
            else if (currentPreviewMode === 'desc') inputId = 'descSelector';
            else if (currentPreviewMode === 'date') inputId = 'dateSelector';
            
            if (!inputId) return;
            
            const inputEl = document.getElementById(inputId);
            if (!inputEl) return;

            // å¦‚æœæ˜¯åˆ—è¡¨é¡¹æ¨¡å¼ï¼Œç›´æ¥æ›¿æ¢
            if (currentPreviewMode === 'item') {
                inputEl.value = path;
                // é«˜äº®ä¸€ä¸‹è¡¨ç¤ºæˆåŠŸ
                inputEl.classList.add('bg-green-50');
                setTimeout(() => inputEl.classList.remove('bg-green-50'), 500);
            } else {
                // å…¶ä»–æ¨¡å¼æ”¯æŒæ¨¡æ¿æ’å…¥
                const currentVal = inputEl.value;
                const insertVal = '{' + path + '}';
                
                if (!currentVal) {
                    inputEl.value = path; // å¦‚æœä¸ºç©ºï¼Œç›´æ¥å¡«è·¯å¾„ï¼ˆå…¼å®¹éæ¨¡æ¿æ¨¡å¼ï¼‰
                } else {
                    // æ’å…¥åˆ°å…‰æ ‡ä½ç½®
                    const start = inputEl.selectionStart;
                    const end = inputEl.selectionEnd;
                    const newVal = currentVal.substring(0, start) + insertVal + currentVal.substring(end);
                    inputEl.value = newVal;
                    
                    // æ¢å¤å…‰æ ‡ä½ç½®
                    setTimeout(() => {
                        inputEl.selectionStart = inputEl.selectionEnd = start + insertVal.length;
                        inputEl.focus();
                    }, 0);
                }
                
                // é«˜äº®ä¸€ä¸‹
                inputEl.classList.add('bg-green-50');
                setTimeout(() => inputEl.classList.remove('bg-green-50'), 500);
            }
        }

        // Init
        checkAuth();
        
        // ç™»å½•è¡¨å•å¤„ç†
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            try {
                const response = await fetch('/admin/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    sessionStorage.setItem('adminToken', data.token);
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadRoutes();
                } else {
                    errorEl.textContent = 'å¯†ç é”™è¯¯ï¼';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                errorEl.textContent = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
                errorEl.classList.remove('hidden');
            }
        });
        
        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            const token = sessionStorage.getItem('adminToken');
            
            try {
                const response = await fetch('/admin/check', {
                    headers: { 'Authorization': 'Bearer ' + (token || '') }
                });
                
                if (response.ok) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadRoutes();
                } else {
                    document.getElementById('loginPage').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('loginPage').classList.remove('hidden');
            }
        }
        
        // æ·»åŠ è®¤è¯å¤´åˆ°æ‰€æœ‰APIè¯·æ±‚
        async function authFetch(url, options = {}) {
            const token = sessionStorage.getItem('adminToken');
            options.headers = options.headers || {};
            options.headers['Authorization'] = 'Bearer ' + (token || '');
            
            const response = await fetch(url, options);
            
            // å¦‚æœ401æœªæˆæƒï¼Œé‡æ–°æ˜¾ç¤ºç™»å½•é¡µé¢
            if (response.status === 401) {
                sessionStorage.removeItem('adminToken');
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
                throw new Error('æœªæˆæƒ');
            }
            
            return response;
        }
        
        // å…¨æ–‡æŠ“å–å¤é€‰æ¡†æ§åˆ¶
        document.getElementById('fullText').addEventListener('change', (e) => {
            const fullTextConfig = document.getElementById('fullTextConfig');
            if (e.target.checked) {
                fullTextConfig.classList.remove('hidden');
            } else {
                fullTextConfig.classList.add('hidden');
            }
        });
        
        // æ—¶é—´æˆ³æ¨¡å¼æ§åˆ¶
        document.getElementById('timestampMode').addEventListener('change', (e) => {
            const timestampConfig = document.getElementById('timestampConfig');
            if (e.target.checked) {
                timestampConfig.classList.remove('hidden');
            } else {
                timestampConfig.classList.add('hidden');
            }
        });
        
        document.getElementById('routeKey').addEventListener('input', (e) => {
             // This is just for the old code compatibility if needed, but we use a new UI now.
             // The new UI doesn't use this specific ID for preview text in the same way, 
             // but let's keep it clean.
        });
        
        // URL è¾“å…¥æ¡†å˜åŒ–æ—¶è‡ªåŠ¨åŠ è½½é¢„è§ˆ
        let urlLoadTimeout;
        document.getElementById('url').addEventListener('input', (e) => {
            clearTimeout(urlLoadTimeout);
            urlLoadTimeout = setTimeout(() => {
                const url = e.target.value;
                if (url && url.startsWith('http')) {
                    loadPreview();
                }
            }, 1000); // 1ç§’å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹åŠ è½½
        });

        // ä¼˜åŒ–äº¤äº’ï¼šèšç„¦è¾“å…¥æ¡†æ—¶è‡ªåŠ¨åˆ‡æ¢å›é¢„è§ˆè§†å›¾
        const autoSwitchInputs = ['url', 'itemSelector', 'titleSelector', 'linkSelector', 'descSelector', 'dateSelector', 'fullTextSelector'];
        autoSwitchInputs.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('focus', () => {
                    // åˆ‡æ¢åˆ°é¢„è§ˆè§†å›¾
                    document.getElementById('previewTitle').textContent = 'å¯è§†åŒ–é¢„è§ˆ';
                    document.getElementById('visualPreview').classList.remove('hidden');
                    document.getElementById('testResult').classList.add('hidden');
                    
                    // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ URL èšç„¦ï¼Œä¸”å½“å‰ä¼¼ä¹æ²¡æœ‰åŠ è½½é¢„è§ˆï¼Œåˆ™å°è¯•åŠ è½½
                    if (id === 'url') {
                        const url = el.value;
                        const frameSrc = document.getElementById('previewFrame').getAttribute('src');
                        const jsonContent = document.getElementById('jsonPreview').innerHTML;
                        
                        // å¦‚æœæœ‰ URL ä½†é¢„è§ˆåŒºåŸŸæ˜¯ç©ºçš„ï¼Œå°è¯•åŠ è½½
                        if (url && url.startsWith('http') && (!frameSrc || frameSrc === '') && (!jsonContent || jsonContent === '')) {
                            loadPreview();
                        }
                    }
                });
            }
        });

        // ç±»å‹é€‰æ‹©å™¨å˜åŒ–æ—¶æ›´æ–°å ä½ç¬¦å¹¶é‡æ–°åŠ è½½é¢„è§ˆ
        document.getElementById('type').addEventListener('change', () => {
            updatePlaceholder();
            loadPreview();
        });
