// --- Folder Modal Logic ---
function openFolderModal(folderName) {
    const modal = document.getElementById('folderModal');
    const title = document.getElementById('folderModalTitle');
    const nameInput = document.getElementById('folderNameInput');
    const routeList = document.getElementById('folderRouteList');
    const searchInput = document.getElementById('folderRouteSearch');

    if (!modal || !nameInput || !routeList) return;

    const isEdit = !!folderName;
    title.textContent = isEdit ? 'ç¼–è¾‘åˆé›†' : 'æ–°å»ºåˆé›†';
    nameInput.value = isEdit ? folderName : '';
    if (searchInput) searchInput.value = '';

    // Populate checkboxes
    const keys = Object.keys(cachedRoutes || {}).sort();
    if (keys.length === 0) {
        routeList.innerHTML = '<div class="text-sm text-gray-500 p-2">æš‚æ— è·¯ç”±</div>';
    } else {
        routeList.innerHTML = keys.map(key => {
            const cfg = cachedRoutes[key] || {};
            const checked = cfg.folder && folderName && cfg.folder === folderName ? 'checked' : '';
            return `<label class="flex items-center gap-2 p-1 text-sm"><input type="checkbox" data-key="${escapeHtml(key)}" ${checked}> <span class="truncate">${escapeHtml(key)} â€” ${escapeHtml(cfg.url || '')}</span></label>`;
        }).join('');
    }

    modal.classList.remove('hidden');
    // focus input
    setTimeout(() => nameInput.focus(), 50);
}

function closeFolderModal() {
    const modal = document.getElementById('folderModal');
    const routeList = document.getElementById('folderRouteList');
    const nameInput = document.getElementById('folderNameInput');
    if (modal) modal.classList.add('hidden');
    if (routeList) routeList.innerHTML = '';
    if (nameInput) nameInput.value = '';
}

function filterFolderRoutes() {
    const qEl = document.getElementById('folderRouteSearch');
    const list = document.getElementById('folderRouteList');
    if (!qEl || !list) return;
    const q = (qEl.value || '').toLowerCase().trim();
    Array.from(list.children).forEach(ch => {
        const txt = ch.textContent || '';
        ch.style.display = q === '' || txt.toLowerCase().includes(q) ? '' : 'none';
    });
}

async function saveFolder() {
    const nameInput = document.getElementById('folderNameInput');
    const list = document.getElementById('folderRouteList');
    const saveBtn = document.getElementById('saveFolderBtn');
    if (!nameInput || !list) return;
    const folderName = (nameInput.value || '').trim();
    if (!folderName) { alert('è¯·è¾“å…¥åˆé›†åç§°'); return; }

    const checks = Array.from(list.querySelectorAll('input[type=checkbox]'));
    // fetch latest routes
    let routes = {};
    try {
        const res = await authFetch(API_BASE);
        routes = await res.json();
    } catch (e) {
        alert('è·å–è·¯ç”±å¤±è´¥: ' + e.message);
        return;
    }

    const checkedSet = new Set(checks.filter(c => c.checked).map(c => c.dataset.key));
    const updates = {};

    Object.keys(routes).forEach(key => {
        const cfg = routes[key] || {};
        const prev = cfg.folder;
        const now = checkedSet.has(key) ? folderName : (prev === folderName ? undefined : prev);
        if ((now || '') !== (prev || '')) {
            const newCfg = { ...cfg };
            if (now === undefined) {
                delete newCfg.folder;
            } else {
                newCfg.folder = now;
            }
            updates[key] = newCfg;
        }
    });

    if (Object.keys(updates).length === 0) {
        closeFolderModal();
        return;
    }

    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
    }

    try {
        const res = await authFetch(API_BASE, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        if (!res.ok) {
            const txt = await res.text();
            alert('ä¿å­˜å¤±è´¥: ' + txt);
        } else {
            // refresh local cache and UI
            const fresh = await authFetch(API_BASE);
            cachedRoutes = await fresh.json();
            renderFolders();
            closeFolderModal();
        }
    } catch (e) {
        alert('ä¿å­˜å¤±è´¥: ' + e.message);
    } finally {
        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'ä¿å­˜'; }
    }
}

async function loadFolders() {
    const listEl = document.getElementById('folderList');
    listEl.innerHTML = '<div class="col-span-full p-4 text-center text-gray-500">åŠ è½½ä¸­...</div>';

    try {
        // Always fetch fresh data
        const res = await authFetch(API_BASE);
        cachedRoutes = await res.json();
        renderFolders();
    } catch (e) {
        listEl.innerHTML = '<div class="col-span-full p-4 text-center text-red-500">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
    }
}

function renderFolders() {
    const listEl = document.getElementById('folderList');

    // Group by folder
    const folders = {};
    Object.entries(cachedRoutes).forEach(([key, config]) => {
        if (config.folder) {
            if (!folders[config.folder]) {
                folders[config.folder] = {
                    name: config.folder,
                    count: 0,
                    routes: [],
                    lastUpdate: 0
                };
            }
            folders[config.folder].count++;
            folders[config.folder].routes.push(key);
            if (config.status && config.status.lastUpdate > folders[config.folder].lastUpdate) {
                folders[config.folder].lastUpdate = config.status.lastUpdate;
            }
        }
    });

    const folderKeys = Object.keys(folders).sort();

    // Get selected token context
    const tokenSelect = document.getElementById('tokenContextSelect');
    let tokenParam = '';
    let tokenName = '';
    if (tokenSelect && tokenSelect.value) {
        tokenParam = '&token=' + encodeURIComponent(tokenSelect.value);
        const tokenObj = window.cachedTokens ? window.cachedTokens[tokenSelect.value] : null;
        if (tokenObj) tokenName = tokenObj.name || (tokenObj.value.substring(0, 8) + '...');
    }

    // Apply layout settings (per-row and aspect ratio)
    try {
        const s = JSON.parse(localStorage.getItem('layout.folders') || '{}');
        let perRow = parseInt(s.perRow || 4, 10) || 4;
        const ratio = s.ratio || '3 / 2';
        // Responsive limits for small screens
        try {
            const w = window.innerWidth || document.documentElement.clientWidth;
            if (w < 640) perRow = 1;
            else if (w < 768) perRow = Math.min(perRow, 2);
        } catch (e) { }
        listEl.style.gridTemplateColumns = `repeat(${perRow}, minmax(0, 1fr))`;
        listEl.style.padding = '0.5rem';
    } catch (e) { }

    if (folderKeys.length === 0) {
        listEl.innerHTML = '<div class="col-span-full p-6 text-center text-gray-500 text-sm">æš‚æ— åˆé›†ï¼Œè¯·åœ¨ç¼–è¾‘è·¯ç”±æ—¶è®¾ç½®"æ–‡ä»¶å¤¹"å­—æ®µ</div>';
        return;
    }

    listEl.innerHTML = '';

    folderKeys.forEach(name => {
        const folder = folders[name];
        const li = document.createElement('div');
        li.className = 'bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow flex flex-col ' + (tokenParam ? 'ring-1 ring-indigo-100' : '');
        // Aspect Ratio
        try {
            const s = JSON.parse(localStorage.getItem('layout.folders') || '{}');
            li.style.aspectRatio = s.ratio || '3 / 2';
        } catch (e) { }

        const tokenBadge = tokenParam ? `<span class="badge bg-indigo-100 text-indigo-700 text-xs border border-indigo-200 mb-1 inline-block" title="é“¾æ¥å·²é™„å¸¦ Token: ${tokenName}">ğŸ”‘ ${tokenName.split(' ')[0]}</span>` : '';

        li.innerHTML = `
            <div class="p-4 flex-1">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold text-gray-900 truncate" title="${folder.name}">ğŸ“‚ ${folder.name}</h3>
                    <span class="badge bg-purple-100 text-purple-700 text-xs">${folder.count} ä¸ªè·¯ç”±</span>
                </div>
                <p class="text-xs text-gray-500 mb-2 line-clamp-2" title="${folder.routes.join(', ')}">åŒ…å«: ${folder.routes.join(', ')}</p>
                ${tokenBadge}
                ${folder.lastUpdate ?
                `<p class="text-xs text-gray-400 mt-1">æœ€è¿‘æ›´æ–°: ${timeAgo(folder.lastUpdate)}</p>`
                : '<p class="text-xs text-gray-400 mt-1">æš‚æ— æ›´æ–°è®°å½•</p>'}
            </div>
            <div class="bg-gray-50 px-4 py-3 border-t border-gray-100 flex items-center justify-between rounded-b-lg">
                <div class="flex gap-2">
                    <a href="/?folder=${encodeURIComponent(folder.name)}&format=rss${tokenParam}" target="_blank" class="text-orange-500 hover:text-orange-600 flex items-center gap-1 text-xs font-medium">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                        RSS
                    </a>
                    <a href="/?folder=${encodeURIComponent(folder.name)}&format=atom${tokenParam}" target="_blank" class="text-blue-500 hover:text-blue-600 flex items-center gap-1 text-xs font-medium">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Atom
                    </a>
                    <a href="/?folder=${encodeURIComponent(folder.name)}&format=json${tokenParam}" target="_blank" class="text-green-500 hover:text-green-600 flex items-center gap-1 text-xs font-medium">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        JSON
                    </a>
                </div>
                <button onclick="openFolderModal('${folder.name}')" class="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    ç¼–è¾‘
                </button>
            </div>
        `;
        // å¼ºåˆ¶å¡ç‰‡ä¸º flex åˆ—å¸ƒå±€ï¼Œä¿æŒæ¯”ä¾‹æ—¶å†…éƒ¨å¯æ­£ç¡®æ”¶ç¼©
        li.style.display = 'flex';
        li.style.flexDirection = 'column';
        li.style.justifyContent = 'space-between';
        li.style.overflow = 'hidden';
        // å†…å®¹åŒºéœ€è¦å¯æ”¶ç¼©ï¼Œé¿å…è¶…å‡ºçˆ¶å®¹å™¨å¯¼è‡´é«˜åº¦ç ´å
        const contentArea = li.querySelector('.p-4');
        if (contentArea) {
            contentArea.style.overflow = 'hidden';
            contentArea.style.minHeight = '0';
            contentArea.style.display = 'flex';
            contentArea.style.flexDirection = 'column';
            contentArea.style.justifyContent = 'space-between';
        }
        listEl.appendChild(li);
    });
}
