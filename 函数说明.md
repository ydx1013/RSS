# 项目函数功能说明文档

本文档详细说明了项目中各个 JavaScript 文件及其包含函数的功能、参数和用途，方便后续维护和调用。

## 目录
1. [根目录文件](#1-根目录文件)
   - [config.js](#configjs)
   - [main.js](#mainjs)
   - [rss.js](#rssjs)
   - [admin_ui.js](#admin_uijs)
2. [Router 模块 (routers/)](#2-router-模块-routers)
   - [routers/custom.js](#routerscustomjs)
   - [routers/feed.js](#routersfeedjs)
   - [routers/json.js](#routersjsonjs)
3. [Utils 工具模块 (utils/)](#3-utils-工具模块-utils)
   - [utils/auth.js](#utilsauthjs)
   - [utils/cache.js](#utilscachejs)
   - [utils/domain.js](#utilsdomainjs)
   - [utils/fetcher.js](#utilsfetcherjs)
   - [utils/helpers.js](#utilshelpersjs)
   - [utils/notify.js](#utilsnotifyjs)

---

## 1. 根目录文件

### `config.js`
项目配置文件。
- **`cacheConfig`**: (Object) 包含缓存策略（成功/失败缓存时长、最大条目数）和默认管理员密码配置。

### `main.js`
Cloudflare Worker 的核心入口文件。
#### `default.fetch(request, env, ctx)`
- **功能**: Worker 的主请求处理程序。
- **流程**:
    1.  处理管理后台路由 (`/admin`, `/admin/auth`, `/api/*`)。
    2.  处理 RSS 生成请求 (通过 `custom`, `json`, `rss` 等参数)。
    3.  管理缓存逻辑 (读取/写入 Cloudflare Cache)。
- **参数**:
    - `request`: Fetch API Request 对象。
    - `env`: 环境变量对象 (含 KV 绑定 `RSS_KV`)。
    - `ctx`: Worker 上下文 (用于 `waitUntil` 等)。

### `rss.js`
负责将数据转换为 RSS/Atom/JSON Feed 格式的逻辑。

#### `escapeXml(unsafe)`
- **功能**: 转义 XML 特殊字符 (`<`, `>`, `&`, `"`, `'`)。
- **参数**: `unsafe` (String) - 待转义字符串。
- **返回**: (String) 转义后的字符串。

#### `itemsToRss(items, channel, format)`
- **功能**: 通用转换入口，根据格式将条目数组转换为最终的 Feed 字符串。
- **参数**:
    - `items`: (Array) 条目对象数组。
    - `channel`: (Object) 频道元数据 (title, link, description 等)。
    - `format`: (String) 输出格式 ('atom' | 'rss' | 'json')。
- **返回**: (String) 生成的 XML 或 JSON 字符串。

#### `generateRss(items, channel)` (内部函数)
- **功能**: 生成 RSS 2.0 格式 XML。

#### `generateAtom(items, channel)` (内部函数)
- **功能**: 生成 Atom 1.0 格式 XML。

#### `generateJsonFeed(items, channel)` (内部函数)
- **功能**: 生成 JSON Feed 1.1 格式 JSON 字符串。

### `admin_ui.js`
管理后台的前端资源加载器。
- **`adminHtml`**: (String) 导出的 HTML 字符串，已将 CSS 和 JS 注入其中，用于 `/admin` 路由响应。

---

## 2. Router 模块 (routers/)

所有 Router 函数均遵循统一签名：`async function(params, config)`。

### `routers/custom.js`
最强大的通用抓取路由，支持 HTML (Cheerio), XPath, 全文抓取等。

#### `default(params, config)`
- **功能**: 处理自定义网页抓取请求。
- **智能逻辑**:
    1.  如果未指定 `type`，尝试自动检测内容类型 (JSON/XML/HTML)。
    2.  如果是 HTML，根据配置使用 Cheerio (CSS选择器) 或 XPath 提取内容。
    3.  支持 `fullText` 全文抓取模式 (对每个 item 发起二次请求)。
- **参数**:
    - `params`: URL 参数对象。
    - `config`: 路由配置对象 (包含选择器 `titleSelector`, `itemSelector` 等)。
- **返回**: `{ data, items, isError }`。

### `routers/feed.js`
处理标准 RSS/Atom 订阅源的路由。

#### `default(params, config)`
- **功能**: 获取并重新标准化现有的 RSS/Atom Feed。
- **特性**:
    - 支持使用 `fetchWithRetry` 进行镜像重试。
    - 支持将 XML 转换为 JSON 进而使用自定义选择器提取 (`itemSelector`)。
    - 支持对 Feed 条目进行全文抓取 (`fullText`)。
- **返回**: `{ data, items, isError, logs, failures }`。

### `routers/json.js`
处理 JSON API 数据的路由。

#### `default(params, config)`
- **功能**: 获取 JSON 数据并将其转换为 RSS。
- **特性**:
    - 使用 `getVal` 支持深层路径提取 (如 `data.list[0].title`)。
    - 支持通过 `{placeholder}` 语法组合字段。
    - 支持倒序排列 (`reverseOrder`)。
- **返回**: `{ data, items, isError }`。

---

## 3. Utils 工具模块 (utils/)

### `utils/auth.js`
认证相关工具。

#### `checkAuth(request, env)`
- **功能**: 验证请求是否包含正确的 Authorization Header (Bearer Token)。
- **返回**: (Boolean) 是否通过。

#### `generateToken(password, env)`
- **功能**: 根据密码生成简单的 Base64 Token。
- **返回**: (String|null) Token。

### `utils/cache.js`
Cloudflare Cache API 封装。

#### `clearRouteCache(key, origin)`
- **功能**: 清除指定路由的所有相关缓存 (rss, atom, json 格式及默认格式)。
- **参数**:
    - `key`: 路由的唯一标识 Key。
    - `origin`: 当前 Worker 的 Origin URL。

#### `getCachedResponse(request)`
- **功能**: `caches.default.match(request)` 的简单封装。

#### `putCachedResponse(request, response, ttl)`
- **功能**: 设置 `Cache-Control` 头并存入缓存。

### `utils/domain.js`
域名处理工具。

#### `getCandidateUrls(url, domainGroups)`
- **功能**: 根据配置的域名组 (Domain Groups)，生成包含镜像域名的候选 URL 列表。
- **参数**:
    - `url`: 原始 URL。
    - `domainGroups`: `[[domain1, domain2], ...]` 格式的域名分组配置。
- **返回**: (Array<String>) 候选 URL 列表。

### `utils/fetcher.js`
网络请求增强工具。

#### `fetchWithHeaders(url, options)`
- **功能**: 模拟浏览器 Header (User-Agent, Accept 等)，尝试绕过反爬虫限制。
- **机制**: 包含多种 UA 变体 (Chrome, Edge, Mobile, Googlebot)，遇阻自动重试。

#### `fetchWithRetry(url, options, domainGroups)`
- **功能**: 结合 `getCandidateUrls` 和 `fetchWithHeaders`，在主域名失败时自动尝试镜像域名。
- **返回**: 响应对象 (附加 `effectiveRequestUrl` 和 `retryFailures` 属性)。

### `utils/helpers.js`
通用辅助函数。

#### `getVal(obj, path)`
- **功能**: 安全地获取嵌套对象的值，支持 `a.b` 和 `a[0].b` 语法。

#### `xmlToJson(xml)`
- **功能**: 使用 Cheerio 将 XML 字符串转换为简化的 JSON 对象，用于自定义 Feed 解析。

#### `decodeText(response, encoding)`
- **功能**: 高级文本解码。
- **流程**:
    1.  优先使用指定的 `encoding`。
    2.  尝试从 `Content-Type` 头检测。
    3.  尝试从 HTML `<meta charset>` 标签检测。
    4.  使用 `jschardet` 进行启发式检测。
    5.  兜底使用 UTF-8。

### `utils/notify.js`
通知服务工具。

#### `sendBarkNotification(barkUrl, title, body, group, url)`
- **功能**: 发送 Bark 手机通知。
- **机制**: 优先尝试 GET 请求 (更稳)，如内容过长自动降级为 POST 请求。
- **参数**:
    - `barkUrl`: Bark 服务器地址。
    - `title`, `body`: 通知标题和内容。
    - `group`: 通知分组 (默认 'RSS-Worker')。
